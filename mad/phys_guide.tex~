%macropackage=LPLAIN
\documentstyle[11pt,twoside,a4p,bezier]{report}
\def\documentlabel#1{\gdef\@documentlabel{#1}}
\gdef\@documentlabel{\tt Second draft}
 
% ***** varying information for partial printing and final copy *****
% *******************************************************************
\newif\ifdraft
\draftfalse

\ifdraft\else
  \documentlabel{CERN/SL/92-?? (AP)}
  \makeindex
\fi

% *******************************************************************

\raggedbottom %required to avoid underfull pages with equations
 
% Allow large floats to be interspersed with the text
\renewcommand{\topfraction}{1.}
\renewcommand{\bottomfraction}{1.}
\renewcommand{\textfraction}{0.1}
\setcounter{topnumber}{10}
\setcounter{bottomnumber}{10}
\setcounter{totalnumber}{20}
 
\def\mad{MAD~Version~8}

\pagestyle{headings}
 
% heading for the \chapter command.
\makeatletter
\def\@makechapterhead#1{{
   \parindent 0pt\raggedright\LARGE \bf
   \ifnum \c@secnumdepth >\m@ne
      \@chapapp{} \thechapter.\ \ \fi
   #1\par\nobreak\vskip 20pt
}}
 
% heading for the \chapter* command.
\def\@makeschapterhead#1{{
   \parindent 0pt\raggedright\LARGE \bf
   #1\par\nobreak\vskip 20pt
}}
 
% titles for the lists of figures and tables:
\def\listoffigures{
   \section*{List of Figures}
   \@starttoc{lof}
}
\def\listoftables{
   \section*{List of Tables}
   \@starttoc{lot}
}
 
% description lists:
\def\mylist{\list{}{
   \setlength{\labelwidth}{2.3cm}
   \setlength{\leftmargin}{2.5cm}
   \let\makelabel\mylabel}
}
 
\let\endmylist\endlist
 
\def\mylabel#1{#1\hfill}
 
% automatic indexing of keywords:
\def\keyitem#1{\item[{\tt #1}]\index{#1}}
\def\ttindex#1{{\tt #1}\index{#1}}
\def\emindex#1{{\em #1\/}\index{#1}}
\def\ttitem#1{\item[{\tt #1}]}
\def\emitem#1{\item[{\em #1}]}
\def\bfitem#1{\item[{\bf #1}]}
 
% MAD command specifications:
\newcommand{\mybox}[1]{
   \begin{quote}
      \tt
      \fbox{
         \begin{minipage}{0.95\textwidth}
            \begin{tabbing}
               #1
            \end{tabbing}
         \end{minipage}
      }
   \end{quote}
}
 
% MAD command examples:
\newcommand{\myxmp}[1]{
   \begin{quote}
      \tt
      \begin{tabbing}
         #1
      \end{tabbing}
   \end{quote}
}

% Some Mathematical Symbols and Operators
\def\half{\frac{1}{2}}
\def\sixth{\frac{1}{6}}
\def\sign{\mathop{\mathrm{sign}}\nolimits}
\def\Tr{\mathop{\mathrm{Tr}}\nolimits}
\def\ad{{\sl Ad\/}}
\def\adphsp{$\{{:}f{:}\}$}
\def\eqdef{\stackrel{def}{=}}
\def\gappeq{\stackrel{>}{\approx}}
\def\lieop#1{{:}{#1}{:}}
\def\lietran#1{e^{{:}{#1}{:}}}
\def\map#1{$\cal #1$}
\def\numclass#1{\mathrm{\bf#1}}
\def\order{order}
\def\phsp{\{Z\}}
\def\pbkt#1#2{\sum_{k=1}^3\left(
  {\partial #1\over\partial q_k}{\partial #2\over\partial p_k} -
  {\partial #1\over\partial p_k}{\partial #2\over\partial q_k}
\right)}

\def\aux{\left(p_x^2+p_y^2+\frac{p_t^2}{\beta^2\gamma^2}\right)}
\def\solaux{\left((p_x+ky)^2+(p_y-kx)^2+\frac{p_t^2}{\beta^2\gamma^2}\right)}

\def\vbar{\overline{v}}
\def\wbar{\overline{w}}

% `array' environment using display style
\long\def\eqarray#1{\vcenter{\let\\=\cr\openup1\jot
  \halign{&\strut$\,\displaystyle{##}\;$\hfil\crcr#1\crcr}}}

% `array' environment using display style for matrices
\long\def\myarray#1{\null\vcenter{\let\\=\cr\openup1\jot
  \halign{&\strut\hfil$\>\displaystyle{##}\>$\hfil\crcr#1\crcr}}}

% left align displayed equations
\def\[#1\]{$$\indent\leftline{$\displaystyle{#1}$}\hss$$}

\tabskip=0pt plus 1fill
\begin{document}
\setlength{\evensidemargin}{\oddsidemargin}
 
\makeatother

% ====================================================================

\ifdraft\else
  \pagenumbering{roman}
\fi
\begin{titlepage}
\begin{center}\normalsize
EUROPEAN ORGANIZATION FOR NUCLEAR RESEARCH
\end{center}
\vskip 0.7cm
\begin{flushright}
\@documentlabel                      % document label
\end{flushright}
\vskip 2.3cm
\begin{center}\LARGE                 % document title
{\bf The MAD Program} \\
(Methodical Accelerator Design) \\
Version 8.7 \\
{\bf Physical Methods Manual}
\end{center}
\vskip 1.5em
\begin{center}                       % author
F. Christoph Iselin
\vskip 2em

{\large \bf Abstract}
\end{center}
\begin{quotation}
MAD is a tool for charged-particle optics in
alternating-gradient accelerators and beam lines.
It can handle from very large to very small accelerators,
and solve various problems on such machines.
 
This document outlines the physical models used in MAD.
It attempts to help the physicist in understanding the precise
functioning of the program.
\end{quotation}

\vfill
\begin{center}
Geneva, Switzerland \\
\today
\end{center}
\end{titlepage}

\ifdraft\else
  \tableofcontents
  \listoffigures
  \listoftables
  \cleardoublepage\pagenumbering{arabic}
\fi

% ====================================================================
 
\chapter{Variables and Units}

\section{Canonical Variables}
Most beam optics programs use the set of variables
\[
x,\quad x',\quad y,\quad y',\quad \Delta s,\quad \Delta p / p_0.\quad
\]
However,
these variables do not form a set of canonical pairs in
six-dimensional phase space.
For this reason MAD uses the set of canonical variables
\[
x, \quad p_x, \quad y, \quad p_y, \quad c \Delta t, \quad \delta =
\Delta E / p_0 c.
\]
From the equation of motion \cite{ISE85} one easily derives the
relations between the slopes $x', y'$ and the canonical momenta
$p_x, p_y$
\[
x' = p_x (1 + hx - \delta / \beta), \qquad
y' = p_y (1 + hx - \delta / \beta),
\]
where $h$ is the curvature of the reference orbit in the mid-plane.
The relative energy error $\delta$
is related to the relative momentum error $\Delta p / p_0$ by
\[
\delta = \Delta E / p_0 c = \beta \Delta p / p_0.
\]
The different choice of variables affects the second-order terms
for all optical transformations,
as described in Section~\ref{diff}.

MAD normally works with the phase space vector
\[
Z=\left(\begin{array}{c}
z_1\\ z_2\\ z_3\\ z_4\\ z_5\\ z_6
\end{array}\right)
=\left(\begin{array}{c}
x\\ p_x\\ y\\ p_y\\ ct\\ \delta
\end{array}\right).
\]
and handles coupling effects through full $6 \times 6$~matrices.

\section{Magnetic Fields}
\label{field}
In magnets MAD defines the magnetic field on the midplane by its
Taylor expansion:
\[
B_y(x,0)=B_0+B_1\frac{x}{1!}+B_2\frac{x^2}{2!}+B_3\frac{x^3}{3!}+\ldots
\]
Positive field coefficients give a contribution to the field
in positive $y$-direction for positive $x$.
The vector potential has a longitudinal component depending on $x, y$
only.
Expanded to order four it has the value
\[\eqarray{
A_{s}(x,y)=
  &+&B_{0}\left(x-\frac{hx^{2}}{2(1+hx)}\right)
   + B_{1}\left(\frac{1}{2}(x^{2}-y^{2})-\frac{h}{6}x^{3}
      +\frac{h^{2}}{24}(4x^{4}-y^{4})+\ldots\right) \\
  &+&B_{2}\left(\frac{1}{6}(x^{3}-3xy^{2})-\frac{h}{24}(x^{4}-y^{4})
      +\ldots\right)
   + B_{3}\left(\frac{1}{24}(x^{4}-6x^{2}y^{2}+y^{4})+\ldots\right)
      +\ldots
}\]
where $h$ is the curvature of the reference orbit.
MAD defines the multipole coefficients as
\[
h=K_0=\frac{B_0}{B\rho}=\frac{qB_0}{p_0}, \qquad
  K_n=\frac{B_n}{B\rho}=\frac{qB_n}{p_0}=
  \frac{1}{B\rho}\frac{\partial^nB_y}{\partial x^n}
\]
$h$ is the curvature of the reference orbit,
$q$ is the particle charge, 
and $B\rho$ is the magnetic stiffness of the particles.
Taking the curl of $A_s$ in curvilinear coordinates the field
components are to order three
\[\eqarray{
B_{x}(x,y)=
  &+&B_{1}\left(y+\frac{h^{2}}{6}y^{3}+\ldots\right) \\
  &+&B_{2}\left(xy-\frac{h^{3}}{6}y^{3}+\ldots\right)
   + B_{3}\left(\frac{1}{6}(3x^{2}y-y^{3})+\ldots\right)+\ldots \\
B_{y}(x,y)=
  &+&B_{0} 
   + B_{1}\left(x-\frac{h}{2}y^{2}+\frac{h^{2}}{2}xy^{2}+\ldots\right) \\
  &+&B_{2}\left(\frac{1}{2}(x^{2}-y^{2})-\frac{h}{2}xy^{2}+\ldots\right)
   + B_{3}\left(\frac{1}{6}(x^{3}-3xy^{2})+\ldots\right)-\ldots
}\]
To simplify notations we introduce the abbreviations
\[
\eqarray{
c(k,l)& &                   &=&\cos(kl)&=&\cosh(ikl)\\
s(k,l)&=&\int_0^l c(k,t)\,dt&=&\sin(kl)/k&=&\sinh(ikl)/ik\\
d(k,l)&=&\int_0^l s(k,t)\,dt&=&\left(1-c(k,l)\right)/k^2\\
f(k,l)&=&\int_0^l d(k,t)\,dt&=&\left(L-s(k,l)\right)/k^2
}
\]
The above functions are related to reference~\cite{SLAC75} as follows:
\[\eqarray{
c_x &=& c(k_x,l), \qquad s_x &=& s(k_x,l), \qquad d_x = h d(k_x,l), \\
c_y &=& c(k_y,l), \qquad s_y &=& s(k_y,l)
}\]

\section{Differences to Other Programs}
\label{diff}

\subsection{Lattice Functions}
The choice of canonical variables in MAD
leads to slightly different definitions of the orbit functions.
In MAD the Courant-Snyder invariants~\cite{COU58}
take the form
$W_x = \gamma_{xM} x^2 - 2 \alpha_{xM} x p_x + \beta_{xM} p_x^2$.
Comparison to the original form
$W_x = \gamma_x x^2 - 2 \alpha_x x x' + \beta_x x'^2$
shows that the orbit functions cannot be the same.
A detailed analysis, using $x' = p_x / (1 + \delta)$,
shows that all formulas can be made consistent by defining the MAD
orbit functions as
\[
\beta_{xM} = \beta_x (1 + \delta) , \quad
\alpha_{xM} = \alpha_x, \quad
\gamma_{xM} = \gamma_x / (1 + \delta).
\]
For constant $\delta$ along the beam line the original orbit functions
can easily be recovered.
In a machine where $\delta$ varies along the circumference, e.g. in a
linear accelerator or in an $e^+e^-$ storage ring,
the definition of the Courant-Snyder invariants must be generalized.
The MAD invariants have the advantage that they
remain invariant along the beam line even for variable $\delta$.
 
\subsection{Second-order Chromaticity in TRANSPORT Algorithms}
It has been noted in~\cite{MIL88} that MAD tends
to return tunes which are too low for non-zero $\Delta p$.
The difference has been found to be quadratic in $\Delta p$ with a
negative coefficient.
This behaviour can be explained by the following considerations:
 
Most programs write the equation of motion in a quadrupole as
\[
x'' + \frac{K}{1 + \delta} x = 0.
\]
This is correct to order~2 in the particle's phase space coordinates;
kinematic terms of higher order are neglected.
MAD derives the equations of motion from a Hamiltonian
developed into a Taylor series and truncated after order~2.
For a quadrupole it uses the equation of motion
\[
x'' + K (1 - \delta) x = 0.
\]
which is equal to the above to order~2 in~$\delta$.
According to~\cite{COU58} the contribution of the quadrupoles to
the chromaticity are
\[
\Delta Q = \frac{1}{4 \pi} \int_0^C \beta \Delta K ds.
\]
Since $1 / (1 + \delta) \approx 1 - \delta + \delta^2 \ldots$,
the linear contribution of either method to the chromaticity is
\[
Q' = - \frac{1}{4 \pi} \int_0^C \beta K ds,
\]
but there is a second-order difference in tune shift
\[
\Delta Q = \frac{\delta^2}{4 \pi} \int_0^C \beta K ds.
\]
This is roughly the natural chromaticity times $\delta^2$;
it accounts quite well for the difference between programs.

% ====================================================================

\chapter{TRANSPORT Maps}
\label{TPT}

\section{Introduction}
\label{TPTIntro}
In MAD a TRANSPORT map (see~\cite{SLAC75,SLAC91}) is defined as the
Taylor series for the exact transfer map, truncated at order two:
\[
z^{(2)}_j = \Delta z_j + \sum_{k=1}^6 R_{jk} z^{(1)}_k
          + \sum_{k=1}^6 \sum_{\ell=1}^6 T_{jk\ell} z^{(1)}_k z^{(1)}_\ell,
          \qquad \mathrm{for} \quad j = 1 \ldots 6.
\]
The $T_{jk\ell}$ array is symmetric with respect to its second and
third index.
Both indices run from 1~to~6, and by convention the off-diagonal terms
are half those used in TRANSPORT.
Below we list only non-zero elements for $k \le \ell$ to save space.

Due to truncation a TRANSPORT map is symplectic only in exceptional cases.
Most TRANSPORT maps have been derived in~\cite{SLAC75}.
However, due to different variables,
the second-order terms are changed as explained in~\cite{ISE85}.
Reference~\cite{ISE85} also gives the formula to derive a TRANSPORT
map from a Lie-algebraic map (see Chapter~\ref{LIE}):
\[\eqarray{
T_{1k\ell}&=&-\frac{1}{2}\sum_{m=1}^6\sum_{n=1}^6F_{2mn}R_{mk}R_{n\ell},\qquad
T_{2k\ell}&=&+\frac{1}{2}\sum_{m=1}^6\sum_{n=1}^6F_{1mn}R_{mk}R_{n\ell},\\
T_{3k\ell}&=&-\frac{1}{2}\sum_{m=1}^6\sum_{n=1}^6F_{4mn}R_{mk}R_{n\ell},\qquad
T_{4k\ell}&=&+\frac{1}{2}\sum_{m=1}^6\sum_{n=1}^6F_{3mn}R_{mk}R_{n\ell},\\
T_{5k\ell}&=&-\frac{1}{2}\sum_{m=1}^6\sum_{n=1}^6F_{6mn}R_{mk}R_{n\ell},\qquad
T_{6k\ell}&=&+\frac{1}{2}\sum_{m=1}^6\sum_{n=1}^6F_{5mn}R_{mk}R_{n\ell}.
}\]

\section{Single Element Maps}

\subsection{Markers}
The \ttindex{MARKER} element has no transfer map.
It is ignored during optics calculation.

\subsection{Drift Spaces}
There are seven drift-like elements in MAD:

\indent\begin{tabular}{llll}
$\bullet$ \tt DRIFT \index{drift} &
$\bullet$ \tt ECOLLIMATOR \index{collimator} &
$\bullet$ \tt RCOLLIMATOR &
$\bullet$ \tt INSTRUMENT \index{instrument} \\
$\bullet$ \tt MONITOR \index{monitor} &
$\bullet$ \tt HMONITOR &
$\bullet$ \tt VMONITOR \\
\end{tabular}
\noindent
All these element types act as field-free regions.
A beam position monitor also returns the position of the beam in its
centre,
and a collimator limits the aperture during tracking.
All have the same transfer matrix,
derived from the element length~$L$:
\[
R=\left(\myarray{
1 & L & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 & 0 \\
0 & 0 & 1 & L & 0 & 0 \\
0 & 0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 0 & 1 & \frac{L}{\beta^2\gamma^2} \\
0 & 0 & 0 & 0 & 0 & 1 \\
}\right ).
\]
Their non-zero second-order terms are
\[
T_{126}=T_{346}=T_{522}=T_{544}=-\frac{L}{2\beta}, \qquad
T_{566}=-\frac{3 L}{2\beta^3\gamma^2}.
\]

\subsection{Bending Magnets}
The TRANSPORT map for bending magnets has been derived
in~\cite{ISE85}
based on the work in~\cite{SLAC75}.
It is composed from three maps,
the fringing field at the magnet entrance ${\cal F}^{(1)}$,
the body of the dipole ${\cal B}$, 
and the fringing field  at the magnet exit ${\cal F}^{(2)}$.
MAD treats all dipoles as \ttindex{SBEND}s,
but for an \ttindex{RBEND} it uses an additional pole face rotation angle
equal to half the bend angle.

\subsubsection{Dipole Fringing Fields}
The fringing field map has been derived in~\cite{SLAC75},
and the required change of variables is described in~\cite{ISE85}.
Let the pole-face rotation angles at entrance and exit be~$\psi_1$
and~$\psi_2$ respectively,
and the curvature of the pole phases be described by the radii~$R_1$
and~$R_2$.
For a dipole of type \ttindex{RBEND} half the bend angle is added to each
of the~$\psi_i$.
If the fringing fields have a finite extent the vertical focusing
angle is changed according to~\cite{SLAC75}:
\[
\overline{\psi_i} = \psi_i - hgI_1 (1 + \sin^2\psi_i).
\]
$h$~is the curvature of the reference orbit within the dipole,
$g$~is the {\em full} gap height, 
and $I_1$~is the first {\em fringing field integral}
\[
I_1=\int_{-\infty}^{\infty}\frac{B_y(s)(B_0-B_y(s))}{g\cdot B_0^2}\,ds.
\]
For both entrance and exit the transfer matrix is
\[
R=\left(\myarray{
1            &0 &0                       &0 &0 &0 \\
+h\tan\psi_i &1 &0                       &0 &0 &0 \\
0            &0 &1                       &0 &0 &0 \\
0            &0 &-h\tan\overline{\psi_i} &1 &0 &0 \\
0            &0 &0                       &0 &1 &0 \\
0            &0 &0                       &0 &0 &1 
}\right).
\]
The second-order terms for the entrance are
\[\eqarray{
T_{111}&=&T_{234}&=&T_{414}&=&-\frac{h}{2}\tan^2\psi_1, \\
T_{212}&=&T_{313}&=&&&+\frac{h}{2}\tan^2\psi_1, \\
T_{133}&=&&&&&+\frac{h}{2}\sec^2\psi_1, \\
T_{423}&=&&&&&-\frac{h}{2}\sec^2\psi_1, \\
T_{211}&=&&&&&+\frac{h}{2R_1}\sec^3\psi_1+K_1\tan\psi_1, \\
T_{233}&=&&&&&-\frac{h}{2R_1}\sec^3\psi_1-K_1\tan\psi_1+
               \frac{h^2}{2}\tan\psi_1(1+\sec^2\psi_1),\\
T_{413}&=&&&&&-\frac{h}{2R_1}\sec^3\psi_1-K_1\tan\psi_1. \\
}\]
and for the exit
\[\eqarray{
T_{111}&=&T_{234}&=&T_{414}&=&+\frac{h}{2}\tan^2\psi_2, \\
T_{212}&=&T_{313}&=&&&-\frac{h}{2}\tan^2\psi_2, \\
T_{133}&=&&&&&-\frac{h}{2}\sec^2\psi_2, \\
T_{423}&=&&&&&+\frac{h}{2}\sec^2\psi_2, \\
T_{211}&=&&&&&+\frac{h}{2R_2}\sec^3\psi_2+K_1\tan\psi_2-
               \frac{h^2}{2}\tan^3\psi_2, \\
T_{233}&=&&&&&-\frac{h}{2R_2}\sec^3\psi_2-K_1\tan\psi_2-
               \frac{h^2}{2}\tan^3\psi_2, \\
T_{413}&=&&&&&-\frac{h}{2R_2}\sec^3\psi_2-K_1\tan\psi_2+
               \frac{h^2}{2}\tan\psi_2\sec^2\psi_2. \\
}\]

\subsubsection{Body of the Dipole}
The magnetic field and the functions $c$, $s$, $d$, and $f$ have been
defined in Section~\ref{field}.
We also define
\[
\eqarray{
k_x^2&=&h^2+K_1,  &\qquad c_x &=&c(k_x,L), &\qquad 
&s_x &=&s(k_x,L), &\qquad d_x &=&d(k_x,L), \\
k_y^2&=&-K_1,     &\qquad c_y &=&c(k_y,L), &\qquad 
&s_y &=&s(k_y,L).
}
\]
For the second-order terms we use seven basic integrals
\[\eqarray{
J_1&=&\int_0^sd_x(t)  \,dt&=&\frac{L-s_x}{k_x^2},\\
J_2&=&\int_0^sd_x^2(t)\,dt&=&\frac{3L-4s_x+s_xc_x}{2 k_x^4},\\
J_3&=&\int_0^sd_x^3(t)\,dt&=&\frac{15L-22s_x+9s_xc_x-2s_xc_x^2}{6 k_x^6},\\
}\]
\[\eqarray{
J_c&=&                    &=&\frac{c(2k_y,s)-c(k_x,s)}{k_x^2-4k_y^2}, \\
J_s&=&\int_0^sJ_c(t)\,dt  &=&\frac{s(2k_y,s)-s(k_x,s)}{k_x^2-4k_y^2}, \\
J_d&=&\int_0^sJ_s(t)\,dt  &=&\frac{d(2k_y,s)-d(k_x,s)}{k_x^2-4k_y^2}, \\
J_f&=&\int_0^sJ_d(t)\,dt  &=&\frac{f(2k_y,s)-f(k_x,s)}{k_x^2-4k_y^2}.
}\]
The transfer matrix for the body of the dipole is
\[
R=\left(\myarray{
c_x       &s_x   &0         &0     &0     &\frac{h}{\beta}d_x   \\
-k_x^2s_x &c_x   &0         &0     &0     &\frac{h}{\beta}s_x   \\
0         &0     &c_y       &s_y   &0     &0 \\
0         &0     &-k_y^2s_y &c_y   &0     &0 \\
-\frac{h}{\beta}s_x &-\frac{h}{\beta}d_x &0 &0 &1
   &\frac{L}{\beta^2\gamma^2}-\frac{h^2}{\beta^2}J_1 \\
0         &0     &0         &0     &0     &1
}\right).
\]
and the non-zero terms of second order:
\[\eqarray{
T_{111}&=&-\frac{1}{6}(K_2+2hK_1)(s_x^2+d_x) - \frac{h}{2}k_x^2 s_x^2,\\
T_{112}&=&-\frac{1}{6}(K_2+2hK_1)s_x d_x + \frac{h}{2}s_x c_x,\\
T_{122}&=&-\frac{1}{6}(K_2+2hK_1)d_x^2 + \frac{h}{2}c_x d_x, \\
T_{116}&=&-\frac{h}{12\beta}(K_2+2hK_1)(3s_x J_1-d_x^2)
 + \frac{h^2}{2\beta} s_x^2  + \frac{1}{4\beta}K_1 Ls_x, \\
T_{126}&=&-\frac{h}{12\beta}(K_2+2hK_1)(s_x d_x^2-2c_x J_2)
 + \frac{h^2}{4\beta} (s_x d_x+c_x J_1)-\frac{1}{4\beta}(s_x+Lc_x), \\
T_{166}&=&-\frac{h^2}{6\beta^2}(K_2+2hK_1)(d_x^3-2s_x J_2)
 + \frac{h^3}{2\beta^2}s_x J_1 - \frac{h}{2\beta^2}Ls_x
 - \frac{h}{2\beta^2\gamma^2}d_x, \\
T_{133}&=&K_1 K_2 J_d + \frac{1}{2}(K_2+hK_1)d_x, \\
T_{134}&=&\frac{1}{2}K_2 J_s, \\
T_{144}&=&K_2 J_d - \frac{h}{2}d_x, \\
}\]
\[\eqarray{
T_{211}&=&-\frac{1}{6}(K_2+2hK_1)s_x(1+2c_x), \\
T_{212}&=&-\frac{1}{6}(K_2+2hK_1)d_x(1+2c_x), \\
T_{222}&=&-\frac{1}{3}(K_2+2hK_1)s_x d_x - \frac{h}{2}s_x, \\
T_{216}&=&-\frac{h}{12\beta}(K_2+2hK_1)(3c_x J_1+s_x d_x)
 - \frac{1}{4\beta}K_1(s_x-Lc_x), \\
T_{226}&=&-\frac{h}{12\beta}(K_2+2hK_1)(3s_x J_1+d_x^2)
 + \frac{1}{4\beta}K_1 Ls_x, \\
T_{266}&=&-\frac{h^2}{6\beta^2}(K_2+2hK_1)(s_x d_x^2-2c_x J_2)
 - \frac{h}{2\beta^2}K_1(c_x J_1-s_x d_x) - \frac{h}{2\beta^2\gamma^2}s_x, \\
T_{233}&=&K_1 K_2 J_s + \frac{1}{2}(K_2+hK_1)s_x, \\
T_{234}&=&\frac{1}{2}K_2 J_c, \\
T_{244}&=&K_2 J_s - \frac{h}{2}s_x, \\
}\]
\[\eqarray{
T_{313}&=&\frac{1}{2}K_2(c_y J_c-2K_1 s_y J_s) + \frac{h}{2}K_1 s_x s_y, \\
T_{314}&=&\frac{1}{2}K_2(s_y J_c-2c_y J_s) + \frac{h}{2}s_x c_y, \\
T_{323}&=&\frac{1}{2}K_2(c_y J_s-2K_1 s_y J_d) + \frac{h}{2}K_1 d_x s_y, \\
T_{324}&=&\frac{1}{2}K_2(s_y J_s-2c_y J_d) + \frac{h}{2}d_x c_y, \\
T_{336}&=&\frac{h}{2\beta}K_2(c_y J_d-2K_1 s_y J_f)
 + \frac{h^2}{2\beta}K_1 J_1 s_y - \frac{1}{4\beta}K_1 Ls_y, \\
T_{346}&=&\frac{h}{2\beta}K_2(s_y J_d-2c_y J_f)
 + \frac{h^2}{2\beta}J_1 c_y - \frac{1}{4\beta}(s_y+Lc_y), \\
}\]
\[\eqarray{
T_{413}&=&\frac{1}{2}K_1 K_2(2c_y J_s-s_y J_c) + \frac{1}{2}(K_2+hK_1)s_x c_y, \\
T_{414}&=&\frac{1}{2}K_2(2K_1 s_y J_s-c_y J_c) + \frac{1}{2}(K_2+hK_1)s_x s_y, \\
T_{423}&=&\frac{1}{2}K_1 K_2(2c_y J_d-s_y J_s) + \frac{1}{2}(K_2+hK_1)d_x c_y, \\
T_{424}&=&\frac{1}{2}K_2(2K_1 s_y J_d-c_y J_s) + \frac{1}{2}(K_2+hK_1)d_x s_y, \\
T_{436}&=&\frac{h}{2\beta}K_1 K_2(2c_y J_f-s_yJ_d) +
  \frac{h}{2\beta}(K_2+hK_1)J_1 c_y + \frac{1}{4\beta}K_1(s_y-Lc_y), \\
T_{446}&=&\frac{h}{2\beta}K_2(2K_1 s_y J_f-c_yJ_d) +
  \frac{h}{2\beta}(K_2+hK_1)J_1 s_y - \frac{1}{4\beta}K_1 Ls_y, \\
}\]
\[\eqarray{
T_{511}&=&\frac{h}{12\beta}(K_2+2hK_1)(s_x d_x+3J_1)
 - \frac{1}{4\beta}K_1(L-s_x c_x), \\
T_{512}&=&\frac{h}{12\beta}(K_2+2hK_1)d_x^2 + \frac{1}{4\beta}K_1 s_x^2, \\
T_{522}&=&\frac{h}{6\beta}(K_2+2hK_1)J_2 - \frac{1}{2\beta}s_x
 - \frac{1}{4\beta}K_1(J_1-s_x d_x), \\
T_{516}&=&\frac{h^2}{12\beta^2}(K_2+2hK_1)(3d_x J_1-4J_2)
 + \frac{h}{4\beta^2}K_1 J_1 (1+c_x) + \frac{h}{2\beta^2\gamma^2}s_x, \\
T_{526}&=&\frac{h^2}{12\beta^2}(K_2+2hK_1)(d_x^3-2s_x J_2)
 + \frac{h}{4\beta^2}K_1 s_x J_1 + \frac{h}{2\beta^2\gamma^2}d_x, \\
T_{566}&=&\frac{h^3}{6\beta^3}(K_2+2hK_1)(3J_3-2d_x J_2)
 + \frac{h^2}{6\beta^3}K_1\left(s_x d_x^2 - J_2(1+2c_x)\right)
 + \frac{3}{2\beta^3\gamma^2}(h^2J_1-L), \\
T_{533}&=&-\frac{h}{\beta}K_1 K_2 J_f - \frac{h}{2\beta}(K_2+hK_1)J_1
 + \frac{1}{4\beta}K_1(L-c_y s_y), \\
T_{534}&=&-\frac{h}{2\beta}K_2 J_d - \frac{1}{4\beta}K_1 s_y^2, \\
T_{544}&=&-\frac{h}{\beta}K_2 J_f + \frac{h^2}{2\beta}J_1
 - \frac{1}{4\beta}(L+c_y s_y).
}\]

\subsection{Quadrupole}
For quadrupoles MAD uses the definitions
\[\eqarray{
k_x^2&=&+K_1, &\qquad c_x&=&c(k_x,L), &\qquad s_x&=&s(k_x,L), \\
k_y^2&=&-K_1, &\qquad c_y&=&c(k_y,L), &\qquad s_y&=&s(k_y,L).
}\]
The quadrupole transfer matrix is
\[
R=\left(\myarray{
c_x       &s_x   &0         &0     &0     &0 \\
-k_x^2s_x &c_x   &0         &0     &0     &0 \\
0         &0     &c_y       &s_y   &0     &0 \\
0         &0     &-k_y^2s_y &c_y   &0     &0 \\
0         &0     &0         &0     &1     &\frac{L}{\beta^2\gamma^2} \\
0         &0     &0         &0     &0     &1
}\right).
\]
And its second-order terms are
\[\eqarray{
T_{116}=T_{226}=+\frac{1}{4\beta}K_1 Ls_x, \qquad &
T_{126}=-\frac{1}{4\beta}(s_x + Lc_x), \qquad &
T_{216}=-\frac{1}{4\beta}K_1(s_x - Lc_x), \\
T_{336}=T_{446}=-\frac{1}{4\beta}K_1 Ls_y, \qquad &
T_{346}=-\frac{1}{4\beta}(s_y + Lc_y), \qquad &
T_{436}=+\frac{1}{4\beta}K_1(s_y - Lc_y), \\
T_{511}=-\frac{1}{4\beta}K_1(L - s_x c_x), \qquad &
T_{512}=+\frac{1}{4\beta}K_1 s_x^2, \qquad &
T_{522}=-\frac{1}{4\beta}(L + s_x c_x), \\
T_{533}=+\frac{1}{4\beta}K_1(L - s_y c_y), \qquad &
T_{534}=-\frac{1}{4\beta}K_1 s_y^2, \qquad &
T_{544}=-\frac{1}{4\beta}(L + s_y c_y), \\
&T_{566}=-\frac{3L}{2\beta^3\gamma^2}.
}\]
The above are the limits obtained by setting $h=0$ and $K_2=0$ in the map
for a combined function dipole.

\subsection{Sextupole}
A sextupole is treated exactly like in TRANSPORT.           
It has the same transfer matrix as a drift space
\[
R=\left(\myarray{
1 & L & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 & 0 \\
0 & 0 & 1 & L & 0 & 0 \\
0 & 0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 0 & 1 & \frac{L}{\beta^2 \gamma^2} \\
0 & 0 & 0 & 0 & 0 & 1 \\
}\right).
\]
$L$ is the sextupole length.
The sextupole strength $K_2$, defined like for a combined function dipole,
produces the non-zero second-order terms
\[\eqarray{
-T_{111} = +T_{133} = K_2\frac{L^2}{4}, \qquad &
-T_{112} = +T_{134} = K_2\frac{L^3}{12}, \qquad &
-T_{122} = +T_{144} = K_2\frac{L^4}{24}, \\
-T_{211} = +T_{233} = K_2\frac{L}{2}, \qquad &
-T_{212} = +T_{234} = K_2\frac{L^2}{4}, \qquad &
-T_{222} = +T_{244} = K_2\frac{L^3}{6}, \\
T_{313} = K_2\frac{L^2}{4}, \qquad &
T_{314} = T_{323} = K_2\frac{L^3}{12}, \qquad &
T_{324} = K_2\frac{L^4}{24}, \\
T_{413} = K_2\frac{L}{2}, \qquad &
T_{414} = T_{423} = K_2\frac{L^2}{4}, \qquad &
T_{424} = K_2\frac{L^3}{6}, \\
T_{126} = T_{346} = -\frac{L}{2\beta}, &
T_{522} = T_{544} = -\frac{L}{2\beta}, &
T_{566} = -\frac{3L}{2\beta^3\gamma^2}. \\
}\]
The above are the limits obtained by setting $h=0$ and $K_2=0$
in the map for a combined function dipole.

\subsection{Octupole}
An octupole is treated as a thin lens placed between two drifts of
half the octupole length.
The map for the thin lens,
evaluated with respect to the actual orbit produces a kick
\[
p_{x2}=p_{k1}-\frac{1}{6}K_3L(x^3-3xy^2), \qquad
p_{y2}=p_{y1}+\frac{1}{6}K_3L(3x^2y-y^3).
\]
Hence the transfer matrix with respect to a given orbit is the unit
matrix augmented with the terms
\[
-R_{21}=+R_{43}=\frac{1}{2}K_3L(x^2-y^2), \qquad
+R_{23}=+R_{41}=K_3Lxy, \\
\]
and the second-order terms around that orbit are
\[
-T_{211}=+T_{233}=+T_{413}=+T_{431}=\frac{1}{2}K_3Lx, \qquad
+T_{213}=+T_{231}=+T_{411}=-T_{433}=\frac{1}{2}K_3Ly.
\]

\subsection{Thin Multipole}
\label{MULTI}
A thin multipole affects the reference system like a dipole,
i.~e. the reference direction changes by the bend angle of its
nominal dipole component.
The total dipole strength thus generates dispersion only;
but a dipole error, if present, also changes the orbit.
Starting with the complex field expansion
\[
B_y + i B_x = \sum_{n=0}^N (B_n + i A_n)\frac{(x + i y)^n}{n!},
\]
we define the complex integrated multipole strength as
\[
K_n L = \frac{1}{B\rho}\int_{-\infty}^{\infty}\Bigl(B_n(s)
  + i A_n(s)\Bigr)\,ds.
\]
By definition the expansion coefficients include the excitation errors.
The absolute error of the dipole coefficient is $\Delta K_0 L$.

The multipole deflects the orbit according to the complex kick
\[
P = \Delta K_0 L - K_0 L \frac{\delta}{\beta}
  + \sum_{n=1}^N K_n L \frac{(x + i y)^n}{n!},
\]
i.~e. it produces the orbit change
\[\eqarray{
p_{x2}&=&p_{x1} - \Re P \\
p_{y2}&=&p_{y1} + \Im P \\
c t_2&=&c t_1 - \frac{1}{\beta}\Re\bigl(K_0 L (x + i y)\bigr) \\
\delta_2&=&\delta_1 - \frac{2 r_e \gamma^3}{3 L} \left | P \right |^2.
}\]
The last change occurs only if the \ttindex{RADIATE} flag is on.

The transfer matrix can be obtained by differentiating the kick.
Defining
\[
P' = \sum_{n=1}^N K_n L \frac{(x + iy)^{n-1}}{(n-1)!},
\]
the geometric terms of the transfer matrix are
\[
-R_{21}=+R_{43}=\Re P', \qquad +R_{23}=+R_{41}=\Im P'.
\]
The {\em total} dipole strength creates the dispersive terms
\[
+R_{26}=-R_{51}=\frac{1}{\beta}\Re(K_0 L), \qquad
-R_{46}=+R_{53}=\frac{1}{\beta}\Im(K_0 L).
\]
The second-order terms are due to components $K_2$ and higher.
They are obtained by differentiating the kick twice.
Defining
\[
P'' = \sum_{n=2}^N K_n L \frac{(x + iy)^{n-2}}{(n-2)!},
\]
these terms become
\[
-T_{211}=+T_{233}=+T_{413}=+T_{431}=\frac{1}{2}\Re P'', \qquad
+T_{213}=+T_{231}=+T_{411}=-T_{433}=\frac{1}{2}\Im P''.
\]

\subsection{Solenoid}
For a solenoid MAD uses the definitions
\[
k=\frac{1}{2}K_s, \qquad C=\cos(kL), \qquad S=\sin(kL),
\]
where $L$ is the solenoid length and $k$ the solenoid strength.
The transfer matrix is
\[
R=\left(\myarray{
  C^2 &  \frac{1}{k} S C &   S C & \frac{1}{k}S^2 & 0 & 0 \\
-kS C &              C^2 & -kS^2 &            S C & 0 & 0 \\
- S C & -\frac{1}{k} S^2 &   C^2 & \frac{1}{k}S C & 0 & 0 \\
 kS^2 &             -S C & -kS C &            C^2 & 0 & 0 \\
0 & 0 & 0 & 0 & 1 & \frac{L}{\beta^2 \gamma^2} \\
0 & 0 & 0 & 0 & 0 & 1 \\
}\right ).
\]
The second-order terms have been evaluated from the Lie
transformation,
elaborated in Chapter~\ref{LIE}:
\[\eqarray{
T_{116} = \frac{kL}{2\beta}\sin(2kL), \quad &
T_{126} = -\frac{L}{2\beta}\cos(2kL), \quad &
T_{136} = -\frac{k L}{2\beta}\cos(2kL), \quad &
T_{146} = -\frac{L}{2\beta}\sin(2kL), \\
T_{216} = \frac{k^2 L}{2\beta}\cos(2kL), \quad &
T_{226} = \frac{kL}{2\beta}\sin(2kL), \quad &
T_{236} = \frac{k^2 L}{2\beta}\sin(2kL), \quad &
T_{246} = -\frac{k L}{2\beta}\cos(2kL), \\
T_{316} = \frac{k L}{2\beta}\cos(2kL), \quad &
T_{326} = \frac{L}{2\beta}\sin(2kL), \quad &
T_{336} = \frac{kL}{\beta}\sin(2kL), \quad &
T_{346} = -\frac{L}{2\beta}\cos(2kL), \\
T_{416} = -\frac{k^2 L}{2\beta}\sin(2kL), \quad &
T_{426} = \frac{k L}{2\beta}\cos(2kL), \quad &
T_{436} = \frac{k^2 L}{2\beta}\cos(2kL), \quad &
T_{446} = \frac{kL}{2\beta}\sin(2kL), \\
T_{511} = -\frac{k^2 L}{2\beta}, \quad &
T_{514} = \frac{k L}{2\beta}, \quad &
T_{544} = -\frac{L}{2\beta}, \\
T_{533} = -\frac{k^2 L}{2\beta}, \quad &
T_{523} = -\frac{k L}{2\beta}, \quad &
T_{522} = -\frac{L}{2\beta}, \\
T_{566} = -\frac{3L}{2\beta^2\gamma^2}.
}\]

\subsection{Orbit Correctors}
An orbit corrector is modeled as a zero-length dipole between two
drifts of half the corrector length.
The reference system is {\em not changed} by the corrector.
The effect of the thin dipole is simply
\[
p_{x2} = p_{x1} + \Delta p_x, \qquad p_{y2} = p_{y1} + \Delta p_y,
\]
where $\Delta p_x$ and $\Delta p_y$ are the kicks in the respective plane.
If the \ttindex{RADIATE} switch is on,
there is also a kick in energy:
\[
\delta_2 = \delta_1 - \frac{2r_e q \gamma^3}{3 L}(\Delta p_x^2 + \Delta p_y^2).
\]
The second-order terms are all zero.

\subsection{RF Cavity}
An RF~cavity is treated in the impulse approximation.
The length of the cavity is simulated by placing the accelerating gap
between two drifts of half the cavity length.
The voltage of the thin cavity is
\[
V = \hat{V}\sin(\phi - \omega t),
\]
where $\hat{V}$ is the peak RF~voltage,
$\phi$ is the RF~phase, and $\omega$ is the RF~frequency.
Hence it produces an accelerating kick of
\[
\delta_2 = \delta_1 + \frac{\hat{V}}{p c}\sin{\phi}.
\]
With respect to the actual orbit it has the transfer matrix
\[
R=\left(\myarray{
1 & 0 & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 & 0 \\
0 & 0 & 1 & 0 & 0 & 0 \\
0 & 0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 0 & 1 & 0 \\
0 & 0 & 0 & 0 & -\omega\frac{\hat{V}}{p c}\cos{\phi} & 1 \\
}\right ).
\]
and one non-zero second-order term
\[
T_{655}=-\omega^2\frac{\hat{V}}{2 p c}\sin\phi.
\]

\subsection{Electrostatic Separator}
\label{TPTsep}
By convention an electrostatic separator does {\em not} change the
reference orbit.
With the abbreviations
\[
k = \frac{q E_y}{p_0 c}, \qquad E_1 = \frac{1}{\beta} + p_t
\]
its exact Hamiltonian is
\[
H = - \sqrt{\left( E_1 + ky \right)^2 - 
            \frac{1}{\beta^2\gamma^2} - \left(p_x^2 + p_y^2\right)}.
\]
The Hamiltonian is an integral of motion, and is constant on any orbit.
It is easily verified that the exact solution for the equations of
motion is 
\[\eqarray{
x_2    &= x_1 + \frac{s}{|H|} p_{x1}, \\
p_{x2} &= p_{x1}, \\
y_2    &= \cosh\left(\frac{ks}{|H|}\right)y_1
         +\frac{1}{k}\sinh\left(\frac{ks}{|H|}\right)p_{y1}
         +\frac{1}{k}\left(\cosh\left(\frac{ks}{|H|}\right)-1\right)E_1,\\
p_{y2} &= k\sinh\left(\frac{ks}{|H|}\right)y_1
         +\cosh\left(\frac{ks}{|H|}\right)p_{y1}
         +\sinh\left(\frac{ks}{|H|}\right)E_1,\\
t_2    &=-\sinh\left(\frac{ks}{|H|}\right)y_1
         -\frac{1}{k}\left(\cosh\left(\frac{ks}{|H|}\right)-1\right)p_{y1}
         +t_1
         -\frac{1}{k}\sinh\left(\frac{ks}{|H|}\right)E_1,\\
p_{t2} &=p_{t1}.\\
}\]
In order to find the TRANSPORT map, we expand these equations to
second order.
We use the abbreviations
\[
C = \cosh(kL), \qquad S = \sinh(kL).
\]
The TRANSPORT map becomes
\[\eqarray{
x_2   &= x_1 + L p_{x1} - \frac{L}{\beta} p_{x1} (k y_1 + p_{t1}),\\
p_{x2}&= p_{x1},\\
y_2   &= \frac{1}{k\beta}(C - 1)
        +\left(C-\frac{kL}{\beta^2}S\right)y_1
        +\frac{1}{k}Sp_{y1}
        +\frac{1}{k}\left(C-1-\frac{kL}{\beta^2}S\right)p_{t1}\\
      & +\frac{L}{2\beta}S(p_{x1}^2+p_{y1}^2)
        -\frac{L}{2\beta}C(ky_1+p_{t1})p_{y1}
        +\frac{L}{2\beta^3}\left(kLC+\frac{3}{\gamma^2}S\right)
          (ky_1+p_{t1})^2,\\
p_{y2}&= \frac{1}{\beta}S
        +k\left(S-\frac{kL}{\beta^2}C\right)y_1
        +Cp_{y1}
        +\left(S-\frac{kL}{\beta^2}C\right)p_{t1}\\
      & +\frac{kL}{2\beta}C(p_{x1}^2+p_{y1}^2)
        -\frac{kL}{2\beta}S(ky_1+p_{t1})p_{y1}
        +\frac{kL}{2\beta^3}\left(kLS+\frac{3}{\gamma^2}C\right)
           (ky_1+p_{t1})^2,\\
t_2   &=-\left(S-\frac{kL}{\beta^2}C\right)y_1
        -\frac{1}{k}(C-1)p_{y1}
        +t_1
        -\frac{1}{k}\left(S-\frac{kL}{\beta^2}C\right)p_{t1}\\
      & -\frac{L}{2\beta}C(p_{x1}^2+p_{y1}^2)
        +\frac{L}{2\beta}S(ky_1+p_{t1})p_{y1}
        -\frac{L}{2\beta^3}\left(kLS+\frac{3}{\gamma^2}C\right)
           (ky_1+p_{t1})^2,\\
p_{t2}&=p_{t1}.\\
}\]
The flight time of the reference particle has been subtracted.

\subsection{Rotation of Reference about the $s$-Axis}
\label{TMSROT}
A rotation about the $s$-axis by an angle $\psi$ is a linear map $\cal R$.
It has the transfer matrix
\[
R = \left(\myarray{
 \cos\psi & 0        & \sin\psi & 0        & 0 & 0 \\
 0        & \cos\psi & 0        & \sin\psi & 0 & 0 \\
-\sin\psi & 0        & \cos\psi & 0        & 0 & 0 \\
 0        &-\sin\psi & 0        & \cos\psi & 0 & 0 \\
 0        & 0        & 0        & 0        & 1 & 0 \\ 
 0        & 0        & 0        & 0        & 0 & 1    
}\right),
\]
and its non-linear terms all vanish.

\subsection{Rotation of Reference About $y$-Axis}
\label{TMYROT}
A rotation about the $y$-axis is a special case of a misalignment
(see below).
With the rotation angle $\phi$ we have a kick
\[
p_{x2}=p_{x1} - \tan\psi,
\]
and the transfer matrix
\[
R = \left(\myarray{
 \cos\phi               & 0          & 0 & 0 & 0 & 0                        \\
 0                      & 1/\cos\phi & 0 & 0 & 0 & -\frac{1}{\beta}\tan\phi \\
 0                      & 0          & 1 & 0 & 0 & 0                        \\
 0                      & 0          & 0 & 1 & 0 & 0                        \\
\frac{1}{\beta}\sin\phi & 0          & 0 & 0 & 1 & 0                        \\
 0                      & 0          & 0 & 0 & 0 & 1  
}\right).
\]
and the second-order terms are ignored.

\subsection{Beam-Beam Interactions}
For a two-dimensional Gaussian particle distribution a closed formula
for the electric field has been given in~\cite{BAS80}.
It uses the following parameters:
\begin{mylist}
\item[$\sigma_x$]
The horizontal standard deviation of the opposite beam,
\item[$\sigma_y$]
The vertical standard deviation of the opposite beam,
\item[$\Delta x$]
The horizontal displacement of the opposite beam with respect to the
ideal orbit.
\item[$\Delta y$]
The vertical displacement of the opposite beam with respect to the
ideal orbit.
\item[$q$]
The number of unit charges per particle in the beam under consideration.
\item[$q'$]
The number of unit charges per particle in the opposite beam.
\item[$N'$]
The number of particles per unit length in the opposite beam,
or the number of particles per bunch in the opposite beam.
\item[$r_e$]
The classical particle radius.
\item[E]
The energy per particle.
\end{mylist}
Note that the electric field can be computed from a scalar potential $\phi$.
The kick acting on the particle can be computed as
\[
K_y + i K_x =
\frac{qq'N'}{E} (\phi_y + i \phi_x) =
\frac{2\sqrt{\pi}r_eN'}{r\gamma} \Bigl(w(z_1) - \exp(z_2^2-z_1^2) w(z_2)\Bigr).
\]
$w$ is the complex error function
\[
w(z)=\exp(-z^2)\left(1+\frac{2i}{\sqrt{\pi}}\int_0^z\exp(z^2)dt\right),
\]
and
\[
\xi  = x + \Delta x, \quad
\eta = y + \Delta y, \quad
r    = \sqrt{2 (\sigma_x^2 - \sigma_y^2)}, \quad
z_1  = \frac{\xi}{r} + i \frac{\eta}{r}, \quad
z_2  = \frac{\sigma_y \xi}{\sigma_x r} + i \frac{\sigma_x \eta}{\sigma_y r}.
\]
For a round beam the above formula produces $0/0$,
and must be replaced by the limit
\[
K_y + i K_x =
\frac{qq'N'}{E} (\phi_y + i \phi_x) =
\frac{2 i r_e N'}{\gamma}
\frac{1 - \exp(- (\xi^2 + \eta^2) / 2 \sigma^2)}{\xi + i\eta}.
\]                                                          
For optical calculations we need the transfer matrix with respect 
to the actual orbit.
It is the identity matrix except for the elements
\[
R_{21} = \frac{qq'N'}{E} \phi_{xx}, \quad
R_{23} = R_{41} = \frac{qq'N'}{E} \phi_{xy}, \quad
R_{43} = \frac{qq'N'}{E} \phi_{yy}.
\]
and the second-order coefficients
\[\eqarray{
T_{211}&=&&&&&\frac{qq'N'}{2E} \phi_{xxx}, \qquad
T_{213}&=&T_{231}&=&T_{411}&=&\frac{qq'N'}{2E} \phi_{xxy}, \\
T_{233}&=&T_{413}&=&T_{431}&=&\frac{qq'N'}{2E} \phi_{xyy}, \qquad
T_{433}&=&&&&&\frac{qq'N'}{2E} \phi_{yyy}.
}\]
which are found by differentiation of the kick.
For an elliptic beam we find
\[\eqarray{
\phi_{xx} &=& \frac{2}{r^2} \left(- (x \phi_x + y \phi_y)
  + \rho_0 \left(1 - \frac{\sigma_y}{\sigma_x}
    \exp\left(-\frac{x^2}{2\sigma_x^2}
              -\frac{y^2}{2\sigma_y^2}\right) \right) \right), \\
%
\phi_{xy} &=& \frac{2}{r^2} \bigl(- (x \phi_y - y \phi_x) \bigr), \\
%
\phi_{yy} &=& \frac{2}{r^2} \left(+ (x \phi_x + y \phi_y)
  - \rho_0 \left(1 - \frac{\sigma_x}{\sigma_y}
    \exp\left(-\frac{x^2}{2\sigma_x^2}
              -\frac{y^2}{2\sigma_y^2}\right) \right) \right), \\
%
\phi_{xxx} &=& \frac{1}{r^2} \left(- \phi_x - (x \phi_{xx} + y \phi_{xy})
  + \rho_0 \frac{x\sigma_y}{\sigma_x^3}
    \exp\left(-\frac{x^2}{2\sigma_x^2}
              -\frac{y^2}{2\sigma_y^2}\right) \right), \\
%
\phi_{xxy} &=& \frac{1}{r^2} \left(-\phi_y-(x\phi_{xy}-y\phi_{xx})\right),\\
%
\phi_{xyy} &=& \frac{1}{r^2} \left(+\phi_x-(x\phi_{yy}-y\phi_{xy})\right),\\
%
\phi_{yyy} &=& \frac{1}{r^2} \left(+ \phi_y + (x \phi_{xy} + y \phi_{yy})
  - \rho_0 \frac{y\sigma_x}{\sigma_y^3}
    \exp\left(-\frac{x^2}{2\sigma_x^2}
              -\frac{y^2}{2\sigma_y^2}\right) \right), \\
}\]
and for a round beam
\[\eqarray{
\phi_{xx} &=& \rho_0 \left(- \frac{x^2-y^2}{(x^2+y^2)^2} (1 - E)
  + \frac{x^2}{\sigma^2(x^2+y^2)} E \right), \\
%
\phi_{xy} &=& \rho_0 \left(- \frac{2xy}{(x^2+y^2)^2} (1 - E)
  + \frac{xy}{\sigma^2(x^2+y^2)} E \right), \\
%
\phi_{yy} &=& \rho_0 \left(+ \frac{x^2-y^2}{(x^2+y^2)^2} (1 - E)
  + \frac{y^2}{\sigma^2(x^2+y^2)} E \right), \\
%
\phi_{xxx} &=& \rho_0 \left(+ \frac{x^3-3xy^2}{(x^2+y^2)^3} (1 - E)
  - \frac{x^3-3xy^2}{2 \sigma^2 (x^2+y^2)^2} E
  - \frac{x^3}{2 \sigma^4 (x^2+y^2)} E \right), \\
%
\phi_{xxy} &=& \rho_0 \left(+ \frac{3x^2y-y^3}{(x^2+y^2)^3} (1 - E)
  - \frac{3x^2y-y^3}{2 \sigma^2 (x^2+y^2)^2} E
  - \frac{x^2y}{2 \sigma^4 (x^2+y^2)} E \right), \\
%
\phi_{xyy} &=& \rho_0 \left(- \frac{x^3-3xy^2}{(x^2+y^2)^3} (1 - E)
  + \frac{x^3-3xy^2}{2 \sigma^2 (x^2+y^2)^2} E
  - \frac{xy^2}{2 \sigma^4 (x^2+y^2)} E \right), \\
%
\phi_{yyy} &=& \rho_0 \left(- \frac{3x^2y-y^3}{(x^2+y^2)^3} (1 - E)
  + \frac{3x^2y-y^3}{2 \sigma^2 (x^2+y^2)^2} E
  - \frac{y^3}{2 \sigma^4 (x^2+y^2)} E \right), \\
}\]
where
\[
E = \exp\left(\frac{x^2+y^2}{2\sigma^2}\right).
\]
It is easy to check that
\[
\phi_{xx} + \phi_{yy} = \rho, \quad
\phi_{xxx} + \phi_{xyy} = \frac{\partial \rho}{\partial x}, \quad
\phi_{xxy} + \phi_{yyy} = \frac{\partial \rho}{\partial y}.
\]
where $\rho$ is the relevant ``space charge''.

\subsection{Misalignment}
Misalignments are defined by three displacements and three angles:
\begin{mylist}
\item[$\Delta x$]
Horizontal displacement,
\item[$\Delta y$]
Vertical displacement,
\item[$\Delta s$]
Longitudinal displacement.
\item[$\theta$]
Rotation about the $s$-axis,
\item[$\phi$]
Rotation about the $x$-axis,
\item[$\psi$]
Rotation about the $y$-axis.
\end{mylist}
In practice misalignments are not known to high precision.
For this and for speed reasons,
MAD uses a linear approximation for its effects.
The three translational components can be composed to form a vector
\[
V = \left(\myarray{ v_1      \\ v_2      \\ v_3      }\right)
  = \left(\myarray{ \Delta x \\ \Delta y \\ \Delta s }\right).
\]
and the three rotational components are represented by an orthogonal matrix
\[\myarray{
W&=&\left(\myarray{
w_{11} & w_{12} & w_{13} \\
w_{21} & w_{22} & w_{23} \\
w_{31} & w_{32} & w_{33} \\
}\right)\\
&=&\left(\myarray{
+\cos\theta \cos\psi-\sin\theta \sin\phi \sin\psi&
-\cos\theta \sin\psi-\sin\theta \sin\phi \cos\psi&\sin\theta \cos\phi\\
\cos\phi \sin\psi & \cos\phi \cos\psi & \sin\phi \\
-\sin\theta \cos\psi-\cos\theta \sin\phi \sin\psi&
+\sin\theta \sin\psi-\cos\theta \sin\phi \sin\psi&\cos\theta \cos\phi \\
}\right).
}\]
The \emindex{misalignment pivot},
i.~e. the point around which the rotation takes place,
is the origin of the reference system at element entrance.
The misalignment generates a canonical transformation.
With the abbreviations
\[\eqarray{
s_2 = w_{13} (x_1 - v_1) + w_{23} (y_1 - v_2) - w_{33} v_3, \\
p_{si}=\sqrt{1+\frac{2p_{ti}}{\beta}+p_{ti}^2-p_{xi}^2-p_{yi}^2},\quad, i = 1, 2.
}\] 
the transformation for the entrance can be written as
\[\eqarray{
p_{x2}&=&w_{11} p_{x1} + w_{21} p_{y1} + w_{31} p_{s1}), \\
p_{y2}&=&w_{12} p_{x1} + w_{22} p_{y1} + w_{32} p_{s1}), \\
p_{t2}&=&p_{t2}.
}\]
\[\eqarray{
x_2&=&w_{11}(x_1-v_1)+w_{21}(y_1-v_2)-w_{31}v_3-\frac{p_{x2}}{p_{s2}}s_2,\\
y_2&=&w_{12}(x_1-v_1)+w_{22}(y_1-v_2)-w_{32}v_3-\frac{p_{y2}}{p_{s2}}s_2,\\
t_2&=&t_1 + \frac{\beta^{-1} + p_{t2}}{p_{s2}} s_2.
}\]
So far the representation is exact.
Linearization around the orbit zero gives the linear transformation
\[
Z^{(2)} = \Delta P + R Z^{(1)}.
\]
where the orbit kicks are
\[\eqarray{
\Delta x&=&(- w_{22} v_1 + w_{12} v_2) / w_{33}, & \qquad & \Delta p_x&=&w_{31}, \\
\Delta y&=&(+ w_{21} v_1 - w_{11} v_2) / w_{33}, & \qquad & \Delta p_y&=&w_{32}, \\
\Delta t&=&- \beta^{-1} s \\
}\]
with
\[
s = (w_{13} v_1 + w_{23} v_2 + w_{33} v_3) / w_{33} .
\] 
The transfer matrix is
\[
R=\left(\myarray{
+\frac{w_{22}}{w_{33}} & +\frac{w_{22}}{w_{33}}s &
-\frac{w_{12}}{w_{33}} & -\frac{w_{12}}{w_{33}}s &
0                      & 0 \\
0 & w_{11} &0 &w_{21} &0 & \frac{w_{31}}{\beta} \\
-\frac{w_{21}}{w_{33}} & -\frac{w_{21}}{w_{33}}s &
+\frac{w_{11}}{w_{33}} & +\frac{w_{11}}{w_{33}}s &
0                      & 0 \\
0 &w_{12} &0 & w_{22} &0 & \frac{w_{32}}{\beta} \\
\frac{w_{13}}{\beta w_{33}} &\frac{w_{13}}{\beta w_{33}}s &
\frac{w_{23}}{\beta w_{33}} &\frac{w_{23}}{\beta w_{33}}s &
1 &- \frac{s}{\beta^2\gamma^2} \\
0 &0 &0 &0 &0 &1
}\right).
\] 
For the misalignment at element exit the displacement and rotation
must be related to the new reference system as follows:
\[
\overline{V} = W_e^{-1} (V + W V_e - V_e), \qquad
\overline{W} = W_e^{-1} W W_e,
\]
where $V_e$ and $W_e$ are the displacement vector and rotation matrix
describing the change of reference when proceeding through the element.
The linear transformation must be inverted:
\[
Z^{(2)} = R^{-1} (Z^{(1)} - \Delta Z).
\]
$V$ and $W$ be replaced by $\overline{V}$ and $\overline{W}$ respectively.
The transfer matrix becomes:
\[
R=\left(\myarray{
\wbar_{11} &-\frac{\wbar_{22}}{\wbar_{33}}s &
\wbar_{21} & \frac{\wbar_{21}}{\wbar_{33}}s &
0 & \frac{\wbar_{13}}{\beta \wbar_{33}}s \\
0 & \frac{\wbar_{22}}{\wbar_{33}} &
0 &-\frac{\wbar_{21}}{\wbar_{33}} &
0 & \frac{\wbar_{13}}{\beta \wbar_{33}} \\
\wbar_{12} & \frac{\wbar_{12}}{\wbar_{33}}s &
\wbar_{22} &-\frac{\wbar_{11}}{\wbar_{33}}s &
0 &-\frac{\wbar_{23}}{\beta \wbar_{33}}s \\
0 &-\frac{\wbar_{12}}{\wbar_{33}} &
0 & \frac{\wbar_{11}}{\wbar_{33}} &
0 & \frac{\wbar_{23}}{\beta \wbar_{33}} \\
\frac{\wbar_{31}}{\beta} &0 &
\frac{\wbar_{32}}{\beta} &0 &
1 & \frac{s}{\beta^2\gamma^2} \\
0 &0 &0 &0 &0 &1
}\right).
\] 

\section{Operations on TRANSPORT Maps}

\subsection{Tilted Elements}
The effect of the \ttindex{TILT} parameter on an element is that the 
reference system is rotated by the angle $\psi = \ttindex{TILT}$ at element
entrance, and by $-\psi$ at element exit.
Such a rotation ${\cal R}$ has been described in Section~\ref{TMSROT}.
The transfer map ${\cal F}$ for the element must be transformed to
\[
\overline{\cal F} = {\cal R \cal F \cal R}^{-1}.
\]

\subsection{Map Composition}
Assume that the two maps ${\cal A} = \{R^a, T^a\}$ and
${\cal B} = \{R^b, T^b\}$ occur in this order in the beam.
The transfer matrix for the composition
${\cal C} = {\cal B A} = \{R^c, T^c\}$ is
\[
R^c = R^b R^a
\]
By substitution of~${\cal A}$ in~${\cal B}$ and truncation at second
order one finds the second-order terms of ${\cal C}$:
\[
T^c_{ijk} = \sum_{\ell=1}^6 R^b_{i\ell} T^a_{\ell jk} +
  \sum_{\ell=1}^6 \sum_{m=1}^6 T^b_{i\ell m} R^a_{\ell j} R^a_{mk}.
\]

\subsection{Map Inversion}
To first order a TRANSPORT map is inverted by inverting its transfer 
matrix.
Since the matrix is symplectic its inverse can be found by the formula
\[
R^{-1} = - S R^T S,
\]
where the superscript~$T$ denotes the transpose and the matrix $S$ is
the symplectic unit matrix
\[
S=\left(\myarray{
 0 & 1 & 0 & 0 & 0 & 0 \\-1 & 0 & 0 & 0 & 0 & 0 \\
 0 & 0 & 0 & 1 & 0 & 0 \\ 0 & 0 &-1 & 0 & 0 & 0 \\
 0 & 0 & 0 & 0 & 0 & 1 \\ 0 & 0 & 0 & 0 &-1 & 0
}\right)
\]
The composition of a map and its inverse must reproduce the identity map.
The equations for this condition may be solved and give:
\[
T^{-1}_{ijk} = - \sum_{\ell=1}^6 \sum_{m=1}^6 \sum_{n=1}^6
  R^{-1}_{i\ell} T_{\ell mn} R^{-1}_{mj} R^{-1}_{nk}.
\]

\subsection{Map Reflection}
The reflection $\overline{\cal T} = \{\overline R, \overline T\}$ of a
transfer map ${\cal T} = \{R,T\}$ represents the traversal of
a beam line in inverse order. Note that this also reverses
asymmetric elements like RF~cavities. Care must be taken if such
elements occur, since this may not be the desired effect.

To compute the reflection, first the formulas of the previous section
are applied.
The signs of all coefficients having an odd number of occurrences
of 2,~4,~or~5 in their indices must then be inverted.
The result is:
\[
\overline R_{ij} = s_i s_j (R^{-1})_{ij}, \qquad
\overline T_{ijk} = s_i s_j s_k (T^{-1})_{ijk},
\]
where $s_1 = s_3 = s_6 = 1, s_2 = s_4 = s_5 = -1$.

\subsection{Closed Orbit}
\label{s-co}
The closed orbit is the first-order fixed point of the transfer map
for one turn around the machine.
MAD searches for the closed orbit along the following steps:

\begin{enumerate}
\item 
Set the initial guess to zero for the transverse phase space
coordinates and to the specified energy error for $\Delta E/p_0c$:
\[
Z_0 = \left ( \myarray{
x_0 \\ p_x0 \\ y_0 \\ p_y0 \\ ct_0 \\ \delta_0
} \right )
= \left ( \myarray{
0 \\ 0 \\ 0 \\ 0 \\ 0 \\ \Delta p/p_0c
} \right ).
\]

\item Find the orbit $Z_1$ after one turn and the Jacobian $R$ of
the map for one turn.

\item Use the Jacobian to find a correction to the initial conditions.
The transverse coordinates must close.

For dynamic maps (including RF~cavities and synchrotron radiation)
the flight time is constrained such as to give the specified energy
error on average.
This leads to the conditions
\[\eqarray{
x_1 &=& x_0 &\qquad p_{x1} &=& p_{x0} \\
y_1 &=& y_0 &\qquad p_{y1} &=& p_{y0} \\
c\cdot t_1 &=& c\cdot t_0 + \frac{C \alpha}{\beta} \frac{\Delta p}{p_0 c}
&\qquad \delta_1&=& \delta_0
}\]
where $C$ is the machine circumference, $\alpha$ is the momentum
compaction, and $\beta$ is the ratio of the particle velocity to the
velocity of light.
The equation for one iteration affects all three degrees of
freedom and reads:
\[
Z_1 + R_j \Delta Z = Z_0 + \Delta Z \qquad \Rightarrow \qquad
\Delta Z = - (R_j - I)^{-1} (Z_1 - Z_0).
\]
Note that when searching for the closed orbit in an \ttindex{OPTICS}
command the flight time difference is always zero.
Thus only $\delta=0$ is permitted.

For static maps (constant energy around the ring) there is no
condition on the flight time difference, and the energy error is
constant.
Thus the equations affect the transverse degrees of freedom only. 

\item Iterate steps~2 and~3 until convergence is achieved.
\end{enumerate} 

When the machine is strongly non-linear, the convergence of this
algorithm may be bad.
In this case the user may enter a value for \ttindex{COFACT} which is
small enough.
MAD will then scale the correction at each iteration such that the
changes for all six phase space variables (expressed in metres and
radians) remain smaller than the numeric value of {\tt COFACT}.

\subsection{Symplectify First-Order Matrix}
\label{symplectify}
The Jacobian matrix of a TRANSPORT map is only approximately symplectic,
whereas the theory requires an exactly symplectic matrix.
An elegant method to make a matrix symplectic has been given in~\cite{HEA86}.
A symplectic matrix~$F$ can be written as $\exp(SM)$ with a
symmetric~$M$.
We may rewrite this as
\[
F = (I + \tanh(SM/2))(I - \tanh(SM/2))^{-1} = (I + W)(I - W)^{-1},
\]
where $W$~is symmetric if and only if $F$~is symplectic.
Given a matrix~$F$ which is approximately symplectic,
we define the matrix
\[
V = S (I - F)(I + F)^{-1}.
\]
which is approximately symmetric.
Using the exactly symmetric matrix $W = (V + V^T) / 2$ we generate an
exactly symplectic matrix from the previous equation.

\section{Tracking}
Tracking by the TRANSPORT method is straightforward.
It uses the definition of the TRANSPORT map:
\[
z^{(2)}_j = \Delta z_j + \sum_{k=1}^6 R_{jk} z^{(1)}_k
          + \sum_{k=1}^6 \sum_{\ell=1}^6 T_{jk\ell} z^{(1)}_k z^{(1)}_\ell,
          \qquad \mathrm{for} \quad j = 1 \ldots 6.
\]
This method is used by default, or if the option
\myxmp{METHOD=TRANSPORT}
is seen on a {\tt RUN} command.
For magnets defined as thin multipoles the thin lens map is used.
Note that the TRANSPORT map tracking is not symplectic;
for long-term tracking it most certainly causes spurious blow up or
shrinking.
For long-term tracking it is recommended to use the Lie-algebraic
methods, or if CPU time is at premium, thin lens tracking.

% ====================================================================

\chapter{Lie Algebraic Maps}
\label{LIE}

\section{Introduction}
\label{LieIntro}
Let the functions $f(p,q)$ and $g(p,q)$ be differentiable functions of
the canonical variables $p$ and $q$. The Poisson bracket of $f$ and
$g$ is defined as
\[
[f,g] = \pbkt{f}{g}.
\]
The Lie operator associated with $f$ is defined as the Poisson bracket
\[
\lieop{f} g = [f,g],
\]
Iterated Lie operators are defined recursively:
\[
\lieop{f}^n g = [f,\lieop{f}^{n-1}g]
\]
and we also use the abbreviations for iterated Lie operators
\[
[f,g,h] = [f,[g,h]], \qquad
[f,g,h,i] = [f,[g,[h,i]]],\qquad
\mathrm{etc.}
\]
The Lie transformation associated with $f$ is defined as the exponential
\[
\lietran{f} g = \sum_{k=0}^\infty \frac{\lieop{f}^k}{k!} g.
\]
An arbitrary Lie transformation acting on the phase space vector $Z$
always represents a symplectic map.
In MAD, like in MARYLIE,
a Lie algebraic map is represented as the composition of Lie
transformations
\[
z^{(2)}_j = \lietran{f_1} \lietran{f_2} \lietran{f_3} \lietran{f_4} \cdots 
  Z^{(1)}_j, \qquad \mathrm{for} \quad j = 1 \ldots 6.
\]
where each $f_k$ is a homogeneous polynomials of order $k$.
The polynomial $f_2$ generates the ordinary transfer matrix.
It is normally not stored, but replaced by that matrix.
For more details refer to~\cite{DOU82,DRA81,HEA86}.

Maps for various elements have been derived in~\cite{DOU82,ISE85}.
Note that the signs of energy and time are inverted in MAD with respect
to~\cite{DOU82} and to the program MARYLIE.
For most single elements MAD carries terms up to order four in the
Hamiltonian.

\section{Single Element Mapss}

\subsection{Markers}
A {\tt MARKER} element has no transfer map.
It is ignored during optics calculation.

\subsection{Drift Spaces}
There are seven drift-like elements in MAD:

\indent\begin{tabular}{llll}
$\bullet$ \tt DRIFT \index{drift} &
$\bullet$ \tt ECOLLIMATOR \index{collimator} &
$\bullet$ \tt RCOLLIMATOR &
$\bullet$ \tt INSTRUMENT \index{instrument} \\
$\bullet$ \tt MONITOR \index{monitor} &
$\bullet$ \tt HMONITOR &
$\bullet$ \tt VMONITOR \\
\end{tabular}
\noindent
All these element types act as field-free regions.
A beam position monitor also returns the position of the beam in its
centre,
and a collimator limits the aperture during tracking.
All have the same transfer map ${\cal F}=\{F,f_i\}$, 
obtained from the element length~$L$,
\[
F=\left(\myarray{
1 & L & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 & 0 \\
0 & 0 & 1 & L & 0 & 0 \\
0 & 0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 0 & 1 & \frac{L}{\beta^2\gamma^2} \\
0 & 0 & 0 & 0 & 0 & 1 \\
}\right ).
\]
Their non-linear generators are~\cite{DOU82}:
\[\eqarray{
f_3&=&\frac{L}{2\beta}\aux p_t,\\
f_4&=&-\frac{L}{2\beta^2}\aux p_t^2-\frac{L}{8}\aux^2.
}\]

\subsection{Bending Magnets}
The Lie algebraic map of order three for a sector dipole has been
derived in~\cite{ISE85}.
It is composed of three maps,
namely the fringing field at the magnet entrance ${\cal F}^{(1)}$,
the body of the dipole ${\cal B}$, 
and the fringing field  ant the magnet exit ${\cal F}^{(2)}$:
\[
{\cal F} = {\cal F}^{(1)} {\cal B} {\cal F}^{(2)}.
\]
MAD treats all dipoles as {\tt SBEND}s,
but for an {\tt RBEND} it uses an additional pole face rotation angle 
equal to half the bend angle.
At present MAD knows only terms up to $f_3$ for dipoles.

\subsubsection{Dipole Fringing Fields}
The fringing field map has been derived for TRANSPORT in~\cite{SLAC75},
and the required change of variables,
together with an equivalent Lie transformation,
is described in~\cite{ISE85}.
The $f_3$~terms have been slightly improved with respect to that reference.
Let the pole face rotation angles at entrance and exit be~$\psi_1$
and~$\psi_2$ respectively,
and the curvature of the pole faces be described by the radii~$R_1$
and~$R_2$.
For a dipole of type {\tt RBEND} half the bend angle is added to each
of the~$\psi_i$.
If the fringing fields have a finite extent the vertical focusing
angles are changed according to~\cite{SLAC75}:
\[
\overline{\psi_i} = \psi_i - hgI_1(1 + \sin^2\psi_i).
\]
$h$~is the curvature of the reference orbit within the dipole,
$g$~is the {\em full} gap height, 
and $I_1$~is the first {\em fringing field integral}
\[
I_1=\int_{-\infty}^{\infty}\frac{B_y(s)(B_0-B_y(s))}{g\cdot B_0^2}\,ds.
\]
For both entrance and exit the transfer matrix is
\[
F^{(i)}=\left(\myarray{
 1           &0 &0                       &0 &0 &0 \\
+h\tan\psi_i &1 &0                       &0 &0 &0 \\
 0           &0 &1                       &0 &0 &0 \\
 0           &0 &-h\tan\overline{\psi_i} &1 &0 &0 \\
 0           &0 &0                       &0 &1 &0 \\
 0           &0 &0                       &0 &0 &1 
}\right).
\]
Using the quadrupole coefficient $K_1$ for the magnet body
the generator $f_3$ for the entrance is
\[\eqarray{
f^{(1)}_3&=&\frac{1}{6}\left(\frac{h}{R_1}\sec^3\psi_1 + 2 K_1\tan\psi_1 -
      2h^2\tan^3\psi_1\right) x^3 \\
   &-&\frac{1}{2}\left(\frac{h}{R_1}\sec^3\psi_1 + 2 K_1\tan\psi_1 -
      h^2\tan\psi_1(\sec^2\psi_1 - \tan^2\overline{\psi_1})\right) x y^2 \\
   &+&\frac{h}{2}\tan\psi_1\Big(x^2p_x\tan\psi_1 -
      2xyp_y\tan\overline{\psi_1}\Big) - \frac{h}{2} p_x y^2 \sec^2\psi_1.
}\]
and for the exit it is
\[\eqarray{
f^{(2)}_3&=&\frac{1}{6}\left(\frac{h}{R_2}\sec^3\psi_2 + 2 K_1\tan\psi_2 +
      h^2\tan^3\psi_2\right) x^3 \\
   &-&\frac{1}{2}\left(\frac{h}{R_2}\sec^3\psi_2 + 2 K_1\tan\psi_2 -
      h^2\tan\psi_2\tan^2\overline{\psi_2}\right) x y^2 \\
   &-&\frac{h}{2}\tan\psi_2\Big(x^2p_x\tan\psi_2 -
      2xyp_y\tan\overline{\psi_2}\Big) + \frac{h}{2} p_x y^2 \sec^2\psi_2.
}\]
The generator $f_4$ is not used by MAD.

\subsubsection{Body of the Dipole}
The magnetic field and the functions $c$, $s$, $d$, and $f$ have been
defined in Section~\ref{field}.
We also define
\[\eqarray{
k_x^2&=&h^2+K_1,  &\quad c_x &=&c(k_x,L), &\quad 
&s_x &=&s(k_x,L), &\quad d_x &=&d(k_x,L), \\
k_y^2&=&-K_1,     &\quad c_y &=&c(k_y,L), &\quad 
&s_y &=&s(k_y,L).
}\]
and seven basic integrals:
\[\eqarray{
J_1&=&\int_0^sd_x(t)  \,dt&=&\frac{L-s_x}{k_x^2} = f_x,\\
J_2&=&\int_0^sd_x^2(t)\,dt&=&\frac{3L-4s_x+s_xc_x}{2 k_x^4},\\
J_3&=&\int_0^sd_x^3(t)\,dt&=&\frac{15L-22s_x+9s_xc_x-2s_xc_x^2}{6 k_x^6},\\
}\]
\[\eqarray{
J_c&=&                    &=&\frac{c(2k_y,s)-c(k_x,s)}{k_x^2-4k_y^2}, \\
J_s&=&\int_0^sJ_c(t)\,dt  &=&\frac{s(2k_y,s)-s(k_x,s)}{k_x^2-4k_y^2}, \\
J_d&=&\int_0^sJ_s(t)\,dt  &=&\frac{d(2k_y,s)-d(k_x,s)}{k_x^2-4k_y^2}, \\
J_f&=&\int_0^sJ_d(t)\,dt  &=&\frac{f(2k_y,s)-f(k_x,s)}{k_x^2-4k_y^2}.
}\]
The transfer matrix for the body of the dipole is
\[
B=\left(\myarray{
c_x       &s_x   &0         &0     &0     &\frac{h}{\beta}d_x   \\
-k_x^2s_x &c_x   &0         &0     &0     &\frac{h}{\beta}s_x   \\
0         &0     &c_y       &s_y   &0     &0 \\
0         &0     &-k_y^2s_y &c_y   &0     &0 \\
-\frac{h}{\beta}s_x &-\frac{h}{\beta}d_x &0 &0 &1
   &\frac{L}{\beta^2\gamma^2}-\frac{h^2}{\beta^2}J_1 \\
0         &0     &0         &0     &0     &1
}\right).
\]
The generator $f_3$ for the non-linear terms is written as
\[
b_3 = \frac{1}{6}\sum_{i=1}^6 \sum_{j=1}^6 \sum_{k=1}^6 B_{ijk} Z_i Z_j Z_k, \\
\]
and has the coefficients
\[\eqarray{\openup 1\jot
B_{111}&=& -\frac{1}{3} (K_2 + 2 h K_1) s_x (2 + c_x^2) - h k_x^4 s_x^3, \\
B_{112}&=& +\frac{1}{3} (K_2 + 2 h K_1) (d_x + s_x^2 c_x) -
  h k_x^2 s_x^2 c_x, \\
B_{116}&=& -\frac{h}{6\beta} (K_2 + 2 h K_1) (3 J_1 - 3 s_x d_x + 2 s_x^3)
  + \frac{h^2}{\beta} k_x^2 s_x^3 + \frac{1}{2\beta} K_1 (L - s_x c_x), \\
B_{122}&=& -\frac{1}{3} (K_2 + 2 h K_1) s_x^3 - h s_x c_x^2, \\
B_{126}&=& +\frac{h}{6\beta} (K_2 + 2 h K_1) d_x^2 (1 + 2 c_x)
  + \frac{h^2}{\beta}s_x^2 c_x + \frac{1}{2\beta} K_1 s_x^2, \\
B_{133}&=&+ 2 K_1 K_2 (k_x^2 s_x J_d + c_x J_s) + (K_2 + h K_1) s_x, \\
B_{134}&=&- K_2 (k_x^2 s_x J_s + c_x J_c), \\
B_{144}&=&+ 2 K_2 (k_x^2 s_x J_d + c_x J_s) - h s_x, \\
B_{166}&=& -\frac{h^2}{3\beta^2} (K_2 + 2 h K_1) (s_x d_x^2 - 2 J_2)
  - \frac{h^3}{\beta^2} s_x^3 - \frac{h}{\beta^2} K_1 (J_1 + s_x d_x)
  - \frac{h}{\beta^2\gamma^2} s_x, \\
B_{222}&=& +\frac{1}{3} (K_2 + 2 h K_1) d_x^2 (2 + c_x) +
  h (d_x + s_x^2 c_x), \\
B_{226}&=& -\frac{h}{3\beta} (K_2 + 2 h K_1) (s_x d_x^2 + J_2)
  - \frac{h^2}{2\beta} \Bigl(J_1 + s_x d_x (1 + 2 c_x)\Bigr)
  + \frac{1}{2\beta} (L + s_x c_x), \\
B_{233}&=&+ 2 K_1 K_2 (c_x J_d - s_x J_s) - (K_2 + h K_1) d_x, \\
B_{234}&=&- K_2 (c_x J_s - s_x J_c), \\
B_{244}&=&2 K_2 (c_x J_d - s_x J_s) + h d_x, \\
B_{266}&=& +\frac{h^2}{3\beta^2} (K_2 + 2 h K_1) d_x^3
  - \frac{h^3}{\beta^2} s_x^2 d_x - \frac{h}{\beta^2} s_x^2
  - \frac{h}{\beta^2\gamma^2} d_x, \\
B_{336}&=&+ \frac{2h}{\beta} K_1 K_2 (J_f + d_x J_s - s_x J_d)
  + \frac{h}{\beta} (K_2 + h K_1) J_1 - \frac{1}{2\beta} K_1 (L - s_y c_y), \\
B_{346}&=&- \frac{h}{\beta} K_2 (J_d + d_x J_c - s_x J_s)
  - \frac{1}{2\beta} K_1 s_y^2, \\
B_{446}&=&+ \frac{2h}{\beta} K_2 (J_f + d_x J_s - s_x J_d)
  - \frac{h^2}{\beta} J_1 + \frac{1}{2\beta} (L + s_y c_y), \\
B_{666}&=& -\frac{h^3}{\beta^3} (K_2 + 2 h K_1) J_3
  - \frac{h^4}{\beta^3} (s_x d_x^2 + J_2)
  + \frac{3h^2}{2\beta^3} (J_1 + s_x d_x)
  + \frac{3}{\beta^3\gamma^2} (L - h^2 J_1).
}\]

\subsection{Quadrupole}
The transfer map for a quadrupole uses the definitions
\[\eqarray{
k_x^2&=&+K_1, &\qquad c_x&=&c(k_x,L), &\qquad s_x&=&s(k_x,L), \\
k_y^2&=&-K_1, &\qquad c_y&=&c(k_y,L), &\qquad s_y&=&s(k_y,L).
}\]
It has the transfer matrix
\[
F=\left(\myarray{
c_x       &s_x   &0         &0     &0     &0 \\
-k_x^2s_x &c_x   &0         &0     &0     &0 \\
0         &0     &c_y       &s_y   &0     &0 \\
0         &0     &-k_y^2s_y &c_y   &0     &0 \\
0         &0     &0         &0     &1     &\frac{L}{\beta^2\gamma^2} \\
0         &0     &0         &0     &0     &1
}\right).
\]
The generator $f_3$ is according to \cite{DOU82}
\[\eqarray{
f_3 = \frac{p_t}{4\beta} \bigl(&+&K_1(L - s_x c_x) x^2 &+& 2K_1s_x^2xp_x
  &+& (L+s_xc_x)p_x^2 \\
  &-&K_1(L-s_yc_y)y^2 &-& 2K_1s_y^2yp_y &+& (L+s_yc_y)p_y^2\bigr)
  + \frac{p_t^3}{2\beta^3\gamma^2}.
}\]
The generator
\[
f_4 = \frac{1}{4!} \sum_{i=1}^6 \sum_{j=1}^6 \sum_{k=1}^6 \sum_{\ell=1}^6
F_{ijk\ell} Z_i Z_j Z_k Z_\ell
\]
has the coefficients
\[\eqarray{
F_{1111}&=&+\frac{K_1^2}{64}\Bigl(-s(4k_x,L)+4s(2k_x,L)-3L\Bigr), \\
F_{1112}&=&-\frac{K_1^3}{8}s^4(k_x,L), \\
F_{1122}&=&+\frac{3K_1}{32}\Bigl(s(4k_x,L)-L\Bigr), \\
F_{1222}&=&+\frac{1}{8}\Bigl(c^4(k_x,L)-1\Bigr), \\
F_{2222}&=&-\frac{1}{64}\Bigl(s(4k_x,L)+4s(2k_x,L)+3L\Bigr), \\
}\]

\[\eqarray{
F_{3333}&=&+\frac{K_1^2}{64}\Bigl(-s(4k_y,L)+4s(2k_y,L)-3L\Bigr), \\
F_{3334}&=&+\frac{K_1^3}{8}s^4(k_y,L), \\
F_{3344}&=&-\frac{3K_1}{32}\Bigl(s(4k_y,L)-L\Bigr), \\
F_{3444}&=&+\frac{1}{8}\Bigl(c^4(k_y,L)-1\Bigr), \\
F_{4444}&=&-\frac{1}{64}\Bigl(s(4k_y,L)+4s(2k_y,L)+3L\Bigr), \\
}\]

\[\eqarray{
F_{1133}&=&+\frac{K_1^2}{32}\biggl(-s(2k_y,L)\Bigl(2-c(2k_x,L)\Bigr)
 -s(2k_x,L)\Bigl(2-c(2k_y,L)\Bigr)+2L\biggr), \\
F_{1134}&=&+\frac{K_1}{32}\biggl(c(2k_y,L)\Bigl(2-c(2k_x,L)\Bigr)
 -4K_1s(2k_x,L)s(2k_y,L)-1\biggr), \\
F_{1144}&=&+\frac{K_1}{32}\biggl(s(2k_x,L)\Bigl(2+c(2k_y,L)\Bigr)
 -s(2k_y,L)\Bigl(2-c(2k_x,L)\Bigr)-2L\biggr), \\
F_{1233}&=&-\frac{K_1}{32}\biggl(c(2k_x,L)\Bigl(2-c(2k_y,L)\Bigr)
 +4K_1s(2k_y,L)s(2k_x,L)-1\biggr), \\
F_{1234}&=&+\frac{K_1}{8}\Bigl(s(2k_x,L)c(2k_y,L)-c(2k_x,L)s(2k_y,L)\Bigr),\\
F_{1244}&=&+\frac{1}{32}\biggl(c(2k_x,L)\Bigl(2+c(2k_y,L)\Bigr)
 -4K_1s(2k_x,L)s(2k_y,L)-3\biggr), \\
F_{2233}&=&-\frac{K_1}{32}\biggl(s(2k_y,L)\Bigl(2+c(2k_x,L)\Bigr)
 -s(2k_x,L)\Bigl(2-c(2k_y,L)\Bigr)-2L\biggr), \\
F_{2234}&=&+\frac{1}{32}\biggl(c(2k_y,L)\Bigl(2+c(2k_x,L)\Bigr)
 +4K_1s(2k_x,L)s(2k_y,L)-3\biggr), \\
F_{2244}&=&-\frac{1}{32}\biggl(s(2k_x,L)\Bigl(2+c(2k_y,L)\Bigr)
 +s(2k_y,L)\Bigl(2+c(2k_x,L)\Bigr)+2L\biggr), \\
}\]

\[\eqarray{
F_{1166}&=&+\frac{K_1}{8}\Bigl(L-s(2k_x,L)\Bigr)
 +\frac{K_1}{16\beta^2}\Bigl(3s(2k_x,L)+L(c(2k_x,L)-4)\Bigr), \\
F_{1266}&=&-\frac{K_1}{4\beta^2}\Bigl(Ls(2k_x,L)+(2-\beta^2)s^2(k_x,L)\Bigr),\\
F_{2266}&=&+\frac{1}{8}\Bigl(L+s(2k_x,L)\Bigr)
 -\frac{1}{16\beta^2}\biggl(5s(2k_x,L)+L\Bigl(6+c(2k_x,L)\Bigr)\biggr), \\
}\]

\[\eqarray{
F_{3366}&=&-\frac{K_1}{8}\Bigl(L-s(2k_y,L)\Bigr)
 -\frac{K_1}{16\beta^2}\Bigl(3s(2k_y,L)+L(c(2k_y,L)-4)\Bigr), \\
F_{3466}&=&+\frac{K_1}{4\beta^2}\Bigl(Ls(2k_y,L)+(2-\beta^2)s^2(k_y,L)\Bigr),\\
F_{4466}&=&+\frac{1}{8}\Bigl(L+s(2k_y,L)\Bigr)
 -\frac{1}{16\beta^2}\biggl(5s(2k_y,L)+L\Bigl(6+c(2k_y,L)\Bigr)\biggr), \\
}\]

\[\eqarray{
F_{6666}&=&+\frac{1}{8\beta^2\gamma^2}\Bigl(1-\frac{5}{\beta^2}\Bigr).
}\]

\subsection{Sextupole}
A sextupole has the same transfer matrix as a drift space
\[
F=\left(\myarray{
1 & L & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 & 0 \\
0 & 0 & 1 & L & 0 & 0 \\
0 & 0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 0 & 1 & \frac{L}{\beta^2 \gamma^2} \\
0 & 0 & 0 & 0 & 0 & 1 \\
}\right ).
\]
$L$ is the sextupole length.
The sextupole strength $K_2$, defined as for a combined function dipole,
produces the generators~\cite{DOU82}:
\[\eqarray{
f_3&=&+\frac{L}{2\beta}\aux p_t-\frac{L}{6}K_2(x^3-3xy^2)
  +\frac{L^2}{4}K_2\left((x^2-y^2)p_x-2xyp_y\right)\\
&-&\frac{L^3}{6}K_2\left(x(p_x^2-p_y^2)-2yp_xp_y\right)
  +\frac{L^4}{24}K_2(p_x^3-3p_xp_y^2).
}\]
\[\eqarray{
f_4&=&\frac{L^3}{48}K_2^2(x^2+y^2)^2
  -\frac{L^4}{24}K_2^2(x^2+y^2)(xp_x+yp_y)\\
&+&\frac{L^5}{480}K_2^2\left((x^2+y^2)(p_x^2+p_y^2)
  +14(xp_x+yp_y)^2\right)\\
&-&\frac{L^6}{96}K_2^2(xp_x+yp_y)(p_x^2+p_y^2)
  +\frac{L^7}{672}K_2^2(p_x^2+p_y^2)^2\\
&-&\frac{L^3}{12}K_2\left(x(p_x^2-p_y^2)-2p_xyp_y\right)
  +\frac{L^4}{24}K_2(p_x^3-3p_xp_y^2)p_t\\
&-&\frac{L}{2\beta^2}\aux p_t^2-\frac{L}{8}\aux^2.
}\]

\subsection{Octupole}
In the Lie algebraic formalism an octupole can be handled as
a lens of finite length.
It has the same transfer matrix as a drift space
\[
F=\left(\myarray{
1 & L & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 & 0 \\
0 & 0 & 1 & L & 0 & 0 \\
0 & 0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 0 & 1 & \frac{L}{\beta^2 \gamma^2} \\
0 & 0 & 0 & 0 & 0 & 1 \\
}\right ).
\]
$L$ is the octupole length.
The non-linear generators are~\cite{DOU82}:
\[\eqarray{
f_3&=&+\frac{L}{2\beta}\aux p_t,\\
f_4&=&-\frac{L}{2\beta^2}\aux p_t^2-\frac{L}{8}\aux^2
      -\frac{K_3}{24}(x^4-6x^2y^2+y^4).
}\]

\subsection{Thin Multipole}
A thin multipole affects the reference system like a dipole,
i.~e. the reference direction changes by the bend angle of its
nominal dipole component.
The total dipole strength thus generates dispersion only;
but a dipole error, if present, also changes the orbit with respect to
the reference.
Starting with the complex field expansion
\[
B_y + i B_x = \sum_{n=0}^N (B_n + i A_n)\frac{(x + i y)^n}{n!},
\]
define the complex integrated multipole strength as
\[
K_nL=\frac{1}{B\rho}\int_{-\infty}^{\infty}\Bigl(B_n(s)+i A_n(s)\Bigr)\,ds.
\]
The expansion coefficients shall include the excitation errors.
The absolute error of the dipole coefficient is $\Delta K_0 L$.

With Lie algebraic maps containing terms up to the order of~$f_4$,
field components can be represented up to the octupole.
The multipole deflects the orbit according to the complex kick
\[
Z = \Delta K_0 L - K_0 L \frac{\delta}{\beta}
  + \sum_{n=1}^3 K_n L \frac{(x + i y)^n}{n!}.
\]
The geometric terms of the transfer matrix are found by differentiation:
\[
-F_{21}=+F_{43}=\Re Z', \qquad +F_{23}=+F_{41}=\Im Z'.
\]
The {\em total} dipole strength creates the dispersive terms
\[
+F_{26}=-F_{51}=\frac{1}{\beta}\Re(K_0 L), \qquad
-F_{46}=+F_{53}=\frac{1}{\beta}\Im(K_0 L).
\]
From the equation for~$Z$ one may derive the generators
\[
f_1=-\Re\Bigl(\Delta K_0 L (x + iy) \Bigr), \qquad
f_3=-\frac{1}{3!}\Re\Bigl(\Delta K_2 L (x - iy)^3 \Bigr), \qquad
f_4=-\frac{1}{4!}\Re\Bigl(\Delta K_3 L (x - iy)^4 \Bigr).
\]

\subsection{Solenoid}
For a solenoid MAD uses the definitions
\[
k=\frac{1}{2}K_s, \qquad C=\cos(kL), \qquad S=\sin(kL),
\]
where $L$ is the solenoid length and $k$ the solenoid strength.
It is easy to see that the Hamiltonian for a solenoid is
\[
H = - \sqrt{E^2 - (p_x + B_0y/2)^2 - (p_y - B_0x/2)^2}.
\]
After transforming all coordinates into deviations from the design orbit
one gets the expansion
\[\eqarray{
\overline{H}&=&\frac{1}{2}\solaux - \frac{1}{2\beta}\solaux p_t \\
       &+&\frac{1}{2\beta^2}\solaux p_t^2 + \frac{1}{8}\solaux^2 + \ldots
}\]
Solving by the techniques of~\cite{DOU82} gives the transfer matrix
\[
F=\left(\myarray{
  C^2 &  \frac{1}{k} S C &   S C & \frac{1}{k}S^2 & 0 & 0 \\
-kS C &              C^2 & -kS^2 &            S C & 0 & 0 \\
- S C & -\frac{1}{k} S^2 &   C^2 & \frac{1}{k}S C & 0 & 0 \\
 kS^2 &             -S C & -kS C &            C^2 & 0 & 0 \\
0 & 0 & 0 & 0 & 1 & \frac{L}{\beta^2 \gamma^2} \\
0 & 0 & 0 & 0 & 0 & 1 \\
}\right ).
\]
The third- and fourth-order parts of the Hamiltonian are invariant
under the linear transformation.
Hence the non-linear generators take a particularly simple form:
\[\eqarray{
f_3&=&+\frac{L}{2\beta}\solaux p_t, \\
f_4&=&-\frac{L}{2\beta^2}\solaux p_t^2 - \frac{L}{8}\solaux^2.
}\]               
Two effects should be considered at the ends of the solenoid.
First, the field lines cannot end abruptly at the ends;
and second, the vector potential is zero outside the solenoid
and finite inside.
The first effect can be estimated by assuming that the magnetic flux lines
bend sharply and concentrate in a radial plane at each end of the solenoid.
The second effect causes the transverse canonical momentum to jump by
the value of $e\vec{A}/B_rho$.
Both transformations are non-symplectic,
but fortunately they cancel in the approximation used.

\subsection{Orbit Correctors}
An orbit corrector is modeled as a zero-length dipole between two
drifts of half the corrector length.
The reference system is {\em not} changed by the corrector.
The transfer matrix of the thin dipole is the identity matrix,
and there is only one generator:
\[
f_1 = x \Delta p_x + y \Delta p_y
    - t \frac{2r_e\gamma^3}{3L} (\Delta p_x^2 + \Delta p_y^2).
\]
where $\Delta p_x$ and $\Delta p_y$ are the kicks in the respective
plane.

\subsection{RF Cavity}
An RF~cavity is treated in the impulse approximation.
The length of the cavity is simulated by placing the accelerating gap
between two drifts of half the cavity length.
The voltage of the thin cavity is
\[
V = \hat{V}\sin(\phi - \omega t),
\]
where $\hat{V}$ is the peak RF~voltage,
$\phi$ is the RF~phase, and $\omega$ is the RF~frequency.
Hence it produces an accelerating kick of
\[
\delta_2 = \delta_1 + \frac{\hat{V}}{p c}\sin(\phi - \omega t).
\]
With respect to the actual orbit we derive the transfer matrix
\[
F=\left(\myarray{
1 & 0 & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 & 0 \\
0 & 0 & 1 & 0 & 0 & 0 \\
0 & 0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 0 & 1 & 0 \\
0 & 0 & 0 & 0 & -\omega\frac{e \hat{V}}{p c}\cos\phi & 1 \\
}\right ).
\]
and the generators~\cite{DOU82}:
\[
f_1 = +\frac{e \hat{V}}{p c} t \sin\phi, \qquad
f_3 = -\frac{\omega^2}{3!} \frac{e \hat{V}}{p c} t^3 \sin\phi, \qquad
f_4 = +\frac{\omega^3}{4!}\frac{e \hat{V}}{p c} t^4 \cos\phi.
\]

\subsection{Electrostatic Separator}
By convention an electrostatic separator does {\em not} change the
reference orbit.
With the abbreviation
\[
k = \frac{q E_y}{p_0 c}
\]
its exact Hamiltonian is
\[
H=-\sqrt{\left(\frac{1}{\beta}+p_t+ky\right)^2-\frac{1}{\beta^2\gamma^2}
            - \left(p_x^2 + p_y^2\right)}.
\]
The exact solution of the equations of motion is given in
Section~\ref{TPTsep}.
From the TRANSPORT map the Lie algebraic map can be derived.
We use the abbreviations
\[
C = \cosh(kL), \qquad S = \sinh(kL).
\]
The orbit deflection is then given by the generator
\[
f_1 = \frac{1}{\beta}\left(S-\frac{kL}{\beta^2}C\right)y+
      \frac{1}{k\beta}(C-1)p_y.
\]
The transfer matrix is
\[
F=\left(\myarray{
1 &L &0 &0 &0 &0 \\
0 &1 &0 &0 &0 &0 \\
0 &0 
&C-\frac{kL}{\beta^2}S &\frac{1}{k}S 
&0 &\frac{1}{k}\left(C-1\right)-\frac{L}{\beta^2}S \\
0 &0 
&k\left(S-\frac{kL}{\beta^2}C\right) &C 
&0 &S-\frac{kL}{\beta^2}C \\
0 &0 
&-\left(S-\frac{kL}{\beta^2}C\right) &-\frac{1}{k}(C-1)
&1 &-\frac{1}{k}S+\frac{L}{\beta^2}C \\ 
0 &0 &0 &0 &0 &1    
}\right).
\]
The generator $f_3$ has the value
\[\eqarray{
f_3 &=&\frac{L}{2\beta} p_x^2 \Big(C(ky+p_t)-Sp_y\Big)
    &+&\left(\frac{k^2L^3}{6\beta^5} + \frac{L}{2\beta^3\gamma^2}\right)
        \Big(C(ky+p_t) - Sp_y\Big)^3 \\
    &-&\frac{kL^2}{2\beta^3}\Big(C(ky+p_t) - Sp_y\Big)^2
        \Big(S(ky + p_t) - Cp_y\Big)
    &+&\frac{L}{2\beta}\Big(C(ky+p_t) - Sp_y\Big)
        \Big(S(ky + p_t) - Cp_y\Big)^2. \\
}\]       
The generator $f_4$ is ignored,
because its coefficients are all small of order one.

\subsection{Rotation about the $s$-Axis}
\label{LMSROT}
A rotation about the $s$-axis by an angle $\psi$ is a linear map
${\cal R}=\{R,r_i\}$.
It has the transfer matrix
\[
F=\left(\myarray{
 \cos\psi & 0        & \sin\psi & 0        & 0 & 0 \\
 0        & \cos\psi & 0        & \sin\psi & 0 & 0 \\
-\sin\psi & 0        & \cos\psi & 0        & 0 & 0 \\
 0        &-\sin\psi & 0        & \cos\psi & 0 & 0 \\
 0        & 0        & 0        & 0        & 1 & 0 \\ 
 0        & 0        & 0        & 0        & 0 & 1    
}\right).
\]
and its generators $r_1$ and $r_k$~for $k\ge 3$ all vanish.

\subsection{Rotation of Reference About $y$-Axis}
A rotation about the $y$-axis is a special case of a misalignment,
derived in~\cite{HEA86}.
With the rotation angle $\phi$ we have the transfer matrix
\[
F=\left(\myarray{
 \cos\phi               & 0          & 0 & 0 & 0 & 0                        \\
 0                      & 1/\cos\phi & 0 & 0 & 0 & -\frac{1}{\beta}\tan\phi \\
 0                      & 0          & 1 & 0 & 0 & 0                        \\
 0                      & 0          & 0 & 1 & 0 & 0                        \\
\frac{1}{\beta}\sin\phi & 0          & 0 & 0 & 1 & 0                        \\
 0                      & 0          & 0 & 0 & 0 & 1  
}\right).
\]
and only the first-order generator
\[
r_1=- x \sin\phi
\]
is considered.

\subsection{Beam-Beam Interactions}
The beam-beam interaction is not yet implemented in MAD
for the Lie algebraic formalism.

\subsection{Misalignment}
Misalignments are defined by three displacements and three angles:
\begin{mylist}
\item[$\Delta x$]
Horizontal displacement,
\item[$\Delta y$]
Vertical displacement,
\item[$\Delta s$]
Longitudinal displacement.
\item[$\theta$]
Rotation about the $s$-axis,
\item[$\phi$]
Rotation about the $x$-axis,
\item[$\psi$]
Rotation about the $y$-axis.
\end{mylist}
Maps for misalignments have been derived in~\cite{HEA86} in the form of 
separate maps for each of the six components of the misalignment.
In practice misalignments are not known to high precision.
For this and for speed reasons,
MAD uses a linear approximation for its effects.
The three translational components form a vector
\[
V = \left(\myarray{ v_1      \\ v_2      \\ v_3      }\right)
  = \left(\myarray{ \Delta x \\ \Delta y \\ \Delta s }\right).
\]
and the three rotational components are represented by an orthogonal matrix
\[\myarray{
W&=&\left(\myarray{
w_{11} & w_{12} & w_{13} \\
w_{21} & w_{22} & w_{23} \\
w_{31} & w_{32} & w_{33} \\
}\right)\\
&=&\left(\myarray{
+\cos\theta \cos\psi-\sin\theta \sin\phi \sin\psi&
-\cos\theta \sin\psi-\sin\theta \sin\phi \cos\psi&\sin\theta \cos\phi\\
\cos\phi \sin\psi & \cos\phi \cos\psi & \sin\phi \\
-\sin\theta \cos\psi-\cos\theta \sin\phi \sin\psi&
+\sin\theta \sin\psi-\cos\theta \sin\phi \sin\psi&\cos\theta \cos\phi \\
}\right).
}\]
The \emindex{misalignment pivot},
i.~e. the point around which the rotation takes place,
is the origin of the reference system at element entrance.
The linear part for the misalignment at entrance is derived
from the linear Transport map.
It has the transfer matrix
\[
R=\left(\myarray{
+\frac{w_{22}}{w_{33}} & +\frac{w_{22}}{w_{33}}s &
-\frac{w_{12}}{w_{33}} & -\frac{w_{12}}{w_{33}}s &
0                      & 0 \\
0 & w_{11} &0 &w_{21} &0 & \frac{w_{31}}{\beta} \\
-\frac{w_{21}}{w_{33}} & -\frac{w_{21}}{w_{33}}s &
+\frac{w_{11}}{w_{33}} & +\frac{w_{11}}{w_{33}}s &
0                      & 0 \\
0 &w_{12} &0 & w_{22} &0 & \frac{w_{32}}{\beta} \\
\frac{w_{13}}{\beta w_{33}} &\frac{w_{13}}{\beta w_{33}}s &
\frac{w_{23}}{\beta w_{33}} &\frac{w_{23}}{\beta w_{33}}s &
1 &\frac{s}{\beta^2\gamma^2} \\
0 &0 &0 &0 &0 &1
}\right),
\] 
and the first-order generator
\[
f_1 = - \Big (w_{13} (x - s p_x) + w_{23} (y - s p_y)\Big) / w_{33}
      + (v_1 p_x + v_2 p_y + \beta^{-1} v_3 p_t).
\]

For the misalignment at element exit the displacement and rotation
must be transformed to the new reference system as follows:
\[
\overline{V} = W_e^{-1} (V + W V_e - V_e), \qquad
\overline{W} = W_e^{-1} W W_e,
\]
where $V_e$ and $W_e$ are the displacement vector and rotation matrix
describing the change of reference when proceeding through the element.
The inverse transformation has the transfer matrix
\[
F=\left(\myarray{
\wbar_{11} &-\frac{\wbar_{22}}{\wbar_{33}}s &
\wbar_{21} & \frac{\wbar_{21}}{\wbar_{33}}s &
0 & \frac{\wbar_{13}}{\beta \wbar_{33}}s \\
0 & \frac{\wbar_{22}}{\wbar_{33}} &
0 &-\frac{\wbar_{21}}{\wbar_{33}} &
0 & \frac{\wbar_{13}}{\beta \wbar_{33}} \\
\wbar_{12} & \frac{\wbar_{12}}{\wbar_{33}}s &
\wbar_{22} &-\frac{\wbar_{11}}{\wbar_{33}}s &
0 &-\frac{\wbar_{23}}{\beta \wbar_{33}}s \\
0 &-\frac{\wbar_{12}}{\wbar_{33}} &
0 & \frac{\wbar_{11}}{\wbar_{33}} &
0 & \frac{\wbar_{23}}{\beta \wbar_{33}} \\
\frac{\wbar_{31}}{\beta} &0 &
\frac{\wbar_{32}}{\beta} &0 &
1 & \frac{s}{\beta^2\gamma^2} \\
0 &0 &0 &0 &0 &1
}\right),
\] 
and the generator
\[
f_1 = - (\wbar_{31} x + \wbar_{32} y)
- \Big((+ \wbar_{22} \vbar_1 - \wbar_{12} \vbar_2) p_x +
       (- \wbar_{21} \vbar_1 + \wbar_{11} \vbar_2) p_y \Big) / \wbar_{33}.
\]

\section{Operations on Lie Algebraic Maps}

\subsection{Tilted Elements}
The effect of the \ttindex{TILT} parameter on an element is that the 
reference system is rotated by the angle $\psi = {\tt TILT}$ at element
entrance, and by $-\psi$ at element exit.
Such a rotation ${\cal R}$ has been described in Section~\ref{LMSROT}.
The transfer map ${\cal F}$ for the element must be transformed to
\[
\overline{\cal F} = {\cal R \cal F \cal R}^{-1}.
\]

\subsection{Map Composition} 
Let us assume that the two maps ${\cal F} = \{F, f_i\}$ and
${\cal G} = \{G, g_i\}$ occur in this order in a beam line.
The problem is to build their composition as follows:
\[
\lietran{f_1} \lietran{f_2} \lietran{f_3} \lietran{f_4} \lietran{f_5}
\lietran{f_6} \ldots
\lietran{g_1} \lietran{g_2} \lietran{g_3} \lietran{g_4} \lietran{g_5}
\lietran{g_6} \ldots\approx
\lietran{h_1} \lietran{h_2} \lietran{h_3} \lietran{h_4} \lietran{h_5}
\lietran{h_6} \ldots = {\cal H} = \{H, h_i\}
\]
with truncation at a predefined order.
Formulas valid up to order~$6$ have been given in Appendix~B
of~\cite{HEA88}.
These formulas have first been implemented in MARYLIE~5.1 and have
been copied and modified for use in MAD.
The formulas are listed here for reference;
for the theory refer to~\cite{HEA88}.

Using the exchange formula
\[
e^{\lieop{f}} e^{\lieop{g}} = e^{\lieop{g}}
e^{\lieop{\exp{\lieop{-g}}f}}
\]
composition is done in three steps.
First consider the problem of moving the first-order term~$g_1$ to the
left:
\[
\lietran{f_1} \lietran{f_2} \lietran{f_3} \lietran{f_4} \lietran{f_5}
\lietran{f_6}
\lietran{g_1} \lietran{g_2} \lietran{g_3} \lietran{g_4} \lietran{g_5}
\lietran{g_6} = 
\lietran{h_1} \lietran{f_2} \lietran{t_2} \lietran{t_3} \lietran{t_4}
\lietran{t_5} \lietran{t_6}
\lietran{g_2} \lietran{g_3} \lietran{g_4} \lietran{g_5}
\lietran{g_6}\]
To move~$g_1$ successively over the polynomials~$f_i$ we define:
\[
j_m^{(n)} = \frac{1}{(n-m)!} \lieop{-g_1}^{(n-m)} f_n,
  \qquad m = 0, 1, \ldots , n, \qquad n = 6, 5, 4, 3.
\]
and then we regroup the various Lie transformations arising:
\[\eqarray{
k_1^{(3)} &=& j_1^{(3)}
           +  \frac{1}{2} [j_2^{(3)},j_1^{(3)}]
           -  \frac{1}{6} [j_1^{(3)},j_3^{(3)},j_1^{(3)}]
           +  \frac{1}{6} [j_2^{(3)},j_2^{(3)},j_1^{(3)}] \\
          &-& \frac{1}{8} [j_1^{(3)},j_3^{(3)},j_2^{(3)},j_1^{(3)}]
           -  \frac{1}{24}[j_2^{(3)},j_1^{(3)},j_3^{(3)},j_1^{(3)}]
           +  \frac{1}{24}[j_2^{(3)},j_2^{(3)},j_2^{(3)},j_1^{(3)}] \\
k_2^{(3)} &=& j_2^{(3)}
           +  \frac{1}{2} [j_3^{(3)},j_1^{(3)}]
           -  \frac{1}{12}[j_2^{(3)},j_3^{(3)},j_1^{(3)}]
           +  \frac{1}{6} [j_3^{(3)},j_2^{(3)},j_1^{(3)}] \\
          &-& \frac{1}{24}[j_2^{(3)},j_3^{(3)},j_2^{(3)},j_1^{(3)}]
           -  \frac{1}{24}[j_3^{(3)},j_1^{(3)},j_3^{(3)},j_1^{(3)}]
           +  \frac{1}{24}[j_3^{(3)},j_2^{(3)},j_2^{(3)},j_1^{(3)}] \\
k_3^{(3)} &=& j_3^{(3)}
           +  \frac{1}{2} [j_3^{(3)},j_2^{(3)}]
           -  \frac{1}{6} [j_2^{(3)},j_3^{(3)},j_2^{(3)}]
           +  \frac{1}{6} [j_3^{(3)},j_3^{(3)},j_1^{(3)}]
           +  \frac{1}{24}[j_2^{(3)},j_2^{(3)},j_3^{(3)},j_2^{(3)}] \\
          &-& \frac{1}{8} [j_2^{(3)},j_3^{(3)},j_3^{(3)},j_1^{(3)}]
           +  \frac{1}{24}[j_3^{(3)},j_2^{(3)},j_3^{(3)},j_1^{(3)}]
           +  \frac{1}{24}[j_3^{(3)},j_3^{(3)},j_2^{(3)},j_1^{(3)}] \\   
k_4^{(3)} &=&-\frac{1}{12}[j_3^{(3)},j_3^{(3)},j_2^{(3)}]
           +  \frac{1}{24}[j_3^{(3)},j_2^{(3)},j_3^{(3)},j_2^{(3)}]
           -  \frac{1}{24}[j_3^{(3)},j_3^{(3)},j_3^{(3)},j_1^{(3)}] \\
k_5^{(3)} &=& \frac{1}{24}[j_3^{(3)},j_3^{(3)},j_3^{(3)},j_2^{(3)}] \\
}\]
\[\eqarray{
k_1^{(4)} &=& j_1^{(4)}
           +  \frac{1}{2} [j_2^{(4)},j_1^{(4)}] \\
k_2^{(4)} &=& j_2^{(4)}
           +  \frac{1}{2} [j_3^{(4)},j_1^{(4)}] \\
k_3^{(4)} &=& j_3^{(4)}
           +  \frac{1}{2} [j_3^{(4)},j_2^{(4)}]
           +  \frac{1}{2} [j_4^{(4)},j_1^{(4)}] \\
k_4^{(4)} &=& j_4^{(4)}
           +  \frac{1}{2} [j_4^{(4)},j_2^{(4)}] \\
k_5^{(4)} &=& \frac{1}{2} [j_4^{(4)},j_3^{(4)}] \\
}\]
\[\eqarray{
k_m^{(5)} &=& j_m^{(5)} \\
k_m^{(6)} &=& j_m^{(6)} \\
}\]
and get the final result:
\[\eqarray{
h_1 &=& f_1 + e^{\lieop{f_2}}
    (g_1 + k_1^{(3)} + k_1^{(4)} + k_1^{(5)} + k_1^{(6)}) \\
t_2 &=& k_2^{(3)} + k_2^{(4)} + k_2^{(5)} + k_2^{(6)}
     +  \frac{1}{2} [k_2^{(3)},k_2^{(4)} + k_2^{(5)}]
     +  \frac{1}{12}[k_2^{(3)},k_2^{(3)},k_2^{(4)}] \\
t_3 &=& k_3^{(3)} + k_3^{(4)} + k_3^{(5)} + k_3^{(6)}
     +              [k_3^{(3)},k_2^{(4)} + k_2^{(5)}] \\
t_4 &=& k_4^{(3)} + k_4^{(4)} + k_4^{(5)} + k_4^{(6)}
     +  \frac{1}{2} [k_3^{(3)},k_3^{(4)} + k_3^{(5)}] \\
t_5 &=& k_5^{(3)} + k_5^{(4)} + k_5^{(5)} + k_5^{(6)}
     -  \frac{1}{6} [k_3^{(3)},k_3^{(3)},k_3^{(4)}], \\
t_6 &=& k_6^{(6)} \\
}\]

The second step converts $t_2$ to a matrix and combines it with the
matrices~$F$ and~$G$.
We note that
\[
t_2 = \frac{1}{2} Z^t W Z, \qquad W \mathrm{\ symmetric},
\]
is of small order~3, and that
\[
\lieop{t_2} Z = J W Z.
\]
Hence, using the approximation $\tanh (x) \approx x - x^3/6$,
we define a symplectic matrix $T$ by
\[\eqarray{
\exp(\lieop{t_2})&=&\exp(JW)Z=(I+\tanh(JW/2))(I-\tanh(JW/2))^{-1} \\
&\approx&TZ=(I+(W/2-W^3/24))(I-(W/2-W^3/24))^{-1}Z.
}\]
In the third step the remaining problem is to convert
\[
\lietran{h_1} \lietran{h_2}
\lietran{u_3} \lietran{u_4} \lietran{u_5} \lietran{u_6}
\lietran{g_3} \lietran{g_4} \lietran{g_5} \lietran{g_6}
= \lietran{h_1} \lietran{h_2}
\lietran{h_3} \lietran{h_4} \lietran{h_5} \lietran{h_6}.
\]
Due to the exchange formula the $t$ polynomials are converted to
\[
u_k = t_k(\lieop{-g_2} Z), \quad k = 3, 4, 5, 6.
\]
The solution is
\[\eqarray{
h_3 &=& f_3 + u_3 \\
h_4 &=& f_4 + u_4 + \frac{1}{2} [f_3,u_3] \\
h_5 &=& f_5 + u_5 - [u_3,f_4] - \frac{1}{6} \lieop{f_3}^2 u_3
     +  \frac{1}{3} \lieop{u_3}^2 f_3 \\
h_6 &=& f_6 + u_6 - [u_3,f_5] + \frac{1}{2} \lieop{u_3}^2 f_4
     +  \frac{1}{2} [f_4,u_4] - \frac{1}{4} [f_4,f_3,u_3] \\
    &-& \frac{1}{4} [u_4,f_3,u_3] + \frac{1}{12} \lieop{f_3}^3 u_3
     -  \frac{1}{8} \lieop{u_3}^3 f_3 + \frac{1}{8} [f_3,u_3,f_3,u_3].
}\]
 
\subsection{Reverse Factorization}
MAD requires only the case where $f_1$ vanishes and the order is four:
\[
{\cal F}=\lietran{f_2}\lietran{f_3}\lietran{f_4}
=\lietran{g_4}\lietran{g_3}\lietran{g_2},
\]
where the second-order polynomials are represented by the
corresponding matrices.
The result is:
\[
G = F, \qquad g_3(Z) = f_3(F Z), \qquad g_4(Z) = g_4(F Z).
\]
 
\subsection{Map Inversion}
MAD requires only the case where $f_1$ vanishes and the order is four.
The inverse of a Lie algebraic map ${\cal F}$ is found in two steps.
First the factorization is reversed as shown in the previous subsection.
The second step uses the formula 
$\left(\lietran{f}\right)^{-1} = \lietran{-f}$
to find the inverse map:
\[
{\cal F}^{-1}=\lietran{-g_2}\lietran{-g_3}\lietran{-g_4}
\]
The matrix of the inverse map is thus~$F^{-1}$,
and the polynomials are the negative of the ones found for the reverse
factorization.

\subsection{Reflection of a Lie Algebraic Map}
Reflection of a transfer map is the transformation needed to simulate
traversal through a beam line in reverse direction.
Note that this also reverses asymmetric elements.

This transformation is equivalent to inversion of the transfer map,
followed by a change of sign for the variables $p_x, p_y$ and $t$.

\subsection{Fixed Point}
Starting with an arbitrary initial approximation~$Z_0$,
an iterative procedure can be defined as follows:
\begin{enumerate}
\item
Define a first-order polynomial~$g_1$ such that
\[
Z_0 = [g_1, Z].
\]
This polynomial represents a map which sends  the origin to the
initial approximation.
\item
Compose the map $\cal F$ with the ``map''~$g_1$ to get~$h_1$
according to the composition algorithm.
$h_1$ then maps the origin onto the orbit at the end of the system.
The matrix~$H$ is the Jacobian of this map and can be used to find
a new approximation:
\[
Z_1 = Z_0 - H^{-1} (\lieop{h_1} Z - Z_0).
\]
\item
Repeat, until convergence is achieved.
\end{enumerate}

\section{Tracking}
When one of the options
\myxmp{METHOD=LIE3|LIE4}
occurs on a {\tt RUN} command, MAD uses the Lie-algebraic tracking
method up to $f_3$~or~$f_4$ terms, respectively.
For {\tt LUMP}s it always uses the order specified on their
definition.
Note that truncating the exponential series
\[
e^{\lieop{f}} Z = \sum_{k=0}^\infty \frac{{\lieop{f}}^k}{k!}
\]
at a finite $k$ {\em does not} produce a symplectic map.
MAD therefore tracks the linear terms using the transfer matrix.
For the non-linear terms~$f_n$ it uses a generating function of the
form
\[
G(q_1,p_2) = q_1 p_2 + \sum_{k=3}^6 g_k(q_1,p_2).
\]
This function is set up such that the resulting canonical
transformation agrees to the desired order with the mapping.
With the temporary values
\[\eqarray{
t_4&=&\sum_{m=1}^3
    \frac{\partial f_3}{\partial q_m}
    \frac{\partial f_3}{\partial p_m}, \\
t_5&=&\sum_{m=1}^3
    \frac{\partial f_3}{\partial q_m}
    \frac{\partial t_4}{\partial p_m}
+ \sum_{\ell=1}^3\sum_{m=1}^3
    \frac{\partial^2f_3}{\partial q_{\ell}\partial q_m}
    \frac{\partial f_3}{\partial p_{\ell}}
    \frac{\partial f_3}{\partial p_m}, \\
t_6&=&\sum_{m=1}^3
    \frac{\partial f_4}{\partial q_m}
    \frac{\partial t_4}{\partial p_m}
+ \sum_{\ell=1}^3\sum_{m=1}^3
    \frac{\partial^2 f_4}{\partial q_{\ell}\partial q_m}
    \frac{\partial f_3}{\partial p_{\ell}}
    \frac{\partial f_3}{\partial p_m}, \\
u_6&=&\sum_{m=1}^3
    \frac{\partial f_3}{\partial q_m}
    \frac{\partial t_5}{\partial p_m}
+ 3\sum_{\ell=1}^3\sum_{m=1}^3
    \frac{\partial^2 f_3}{\partial q_{\ell}\partial q_m}
    \frac{\partial f_3}{\partial p_{\ell}}
    \frac{\partial t_4}{\partial p_m}
+ \sum_{k=1}^3\sum_{\ell=1}^3\sum_{m=1}^3
    \frac{\partial^3 f_3}{\partial q_k\partial q_{\ell}\partial q_m}
    \frac{\partial f_3}{\partial p_k}
    \frac{\partial f_3}{\partial p_{\ell}}
    \frac{\partial f_3}{\partial p_m}, \\
}\]
it can be written as
\[\eqarray{
g_3 &=& f_3, \\ 
g_4 &=& f_4 + \frac{1}{2} t_4, \\
g_5 &=& f_5 - \frac{1}{6} t_5
+ \frac{1}{2}\sum_{m=1}^3
    \frac{\partial f_4}{\partial q_k}
    \frac{\partial f_3}{\partial p_k}, \\
g_6 &=& f_6 + \frac{1}{24} t_6 - \frac{1}{2} u_6
+ \sum_{m=1}^3
    \frac{\partial f_5}{\partial q_k}
    \frac{\partial f_3}{\partial p_k}
+ \frac{1}{2}\sum_{m=1}^3
    \frac{\partial f_4}{\partial q_k}
    \frac{\partial f_4}{\partial p_k}. \\
}\]
The generating function is truncated at the order of the
Lie transformation given.

% ====================================================================

\chapter{Survey}
\label{survey}

\section{Global Reference System}
\label{layout}
\index{global reference}
\index{global coordinates}
\index{coordinates}
\index{local origin}
The reference orbit of the accelerator is uniquely defined by the
sequence of physical elements.
The local reference system $(x, y, s)$ may thus be referred
to a global Cartesian coordinate system $(X, Y, Z)$
(see Figure~\ref{global}).
The positions between beam elements are numbered $0,\ldots,i,\ldots,n$.
The local reference system $(x_{i}, y_{i}, z_{i})$
at position $i$,
i.e. the displacement and direction of the reference orbit
with respect to the system $(X, Y, Z)$ are characterized by
three displacements $(X_{i}, Y_{i}, Z_{i})$
and three angles $(\theta_{i}, \phi_{i}, \psi_{i})$
The above quantities are defined more precisely as follows:
 
\begin{figure}[ht]
\centering
\setlength{\unitlength}{1pt}
\begin{picture}(400,270)
% global axes
\thicklines
\put(20,150){\vector(2,-1){280}}
\put(290,35){\makebox(0,0){$Z$}}
\put(20,100){\vector(3,1){360}}
\put(370,200){\makebox(0,0){$X$}}
\put(80,0){\vector(0,1){270}}
\put(70,240){\makebox(0,0){$Y$}}
%local axes
\put(133.3,0){\vector(1,3){90}}
\put(213.3,260){\makebox(0,0){$x$}}
\put(300,150){\vector(-2,1){180}}
\put(150,215){\makebox(0,0){$y$}}
\put(0,100){\vector(2,1){270}}
\put(260,240){\makebox(0,0){$s$}}
% projection of s onto ZX
\thinlines
\put(80,120){\circle*{4}}
\put(200,200){\circle*{4}}
\put(0,110){\line(1,0){290}}
\put(300,110){\makebox(0,0)[l]{\shortstack{projection of $s$ \\
onto $ZX$-plane}}}
\put(20,110){\circle*{4}}
\put(50,110){\circle*{4}}
\put(100,110){\circle*{4}}
% displacement of local system
\put(140,140){\line(2,-1){60}}
\put(160,128){\makebox(0,0)[tr]{$Z$}}
\put(140,90){\line(3,1){60}}
\put(190,100){\makebox(0,0)[tl]{$X$}}
\put(200,110){\line(0,1){90}}
\put(205,140){\makebox(0,0)[l]{$Y$}}
\put(140,90){\circle*{4}}
\put(140,140){\circle*{4}}
\put(200,110){\circle*{4}}
% intersection of xy and ZX
\put(130,0){\line(1,1){230}}
\put(135,5){\circle*{4}}
\put(193.3,63.3){\circle*{4}}
\put(240,110){\circle*{4}}
\put(286.7,156.7){\circle*{4}}
\put(335,205){\circle*{4}}
\thicklines
\put(180,20){\vector(-1,1){12}}
\put(180,20){\makebox(0,0)[tl]{\shortstack{intersection of \\
$xy$ and $ZX$ planes}}}
% reference orbit
\bezier{80}(140,150)(170,185)(200,200)
\bezier{80}(200,200)(230,215)(260,220)
\put(260,220){\makebox(0,0)[l]{\shortstack{reference \\orbit}}}
% roll angle
\bezier{30}(160,30)(160,40)(150,50)
\put(152,48){\vector(-1,1){2}}
\put(150,30){\makebox(0,0){$\psi$}}
\put(140,30){\makebox(0,0)[br]{roll angle}}
% pitch angle
\bezier{20}(60,110)(60,120)(55,125)
\put(57,123){\vector(-1,2){2}}
\put(50,118){\makebox(0,0){$\phi$}}
\put(40,125){\makebox(0,0)[br]{pitch angle}}
% azimuth
\bezier{20}(130,95)(140,100)(140,110)
\put(140,105){\vector(0,1){5}}
\put(130,105){\makebox(0,0){$\theta$}}
\put(115,95){\makebox(0,0)[t]{azimuth}}
\end{picture}
\caption{Global Reference System}
\label{global}
\end{figure}
 
\begin{mylist}
\item[$X$]
\index{X}
Displacement of the local origin in $X$-direction.
\item[$Y$]
\index{Y}
Displacement of the local origin in $Y$-direction.
\item[$Z$]
\index{Z}
Displacement of the local origin in $Z$-direction.
\keyitem{$\theta$}
\index{rotation angle}
\index{angle of rotation}
\index{azimuth}
Angle of rotation (azimuth) about the global $Y$-axis,
between the global $Z$-axis and the projection
of the reference orbit onto the $(Z, X)$-plane.
A positive angle $\theta$ forms a right-hand screw with the
$Y$-axis.
\keyitem{$\phi$}
\index{elevation angle}
Elevation angle,
i.e. the angle between the reference orbit and its projection
onto the $(Z, X)$-plane.
A positive angle $\phi$ correspond to increasing $Y$.
If only horizontal bends are present,
the reference orbit remains in the $(Z, X)$-plane.
In this case $\phi$ is always zero.
\keyitem{$\psi$}
\index{roll angle}
\index{tilt angle}
Roll angle about the local $s$-axis,
i.e. the angle between the intersection
of the $(x, y)$ and $(Z, X)$-planes and the local $x$-axis.
A positive angle $\psi$ forms a right-hand screw with the $s$-axis.
\end{mylist}
The angles $(\theta, \phi, \psi)$ are {\it not} the Euler angles.
The reference orbit starts at the origin and points by default
in the direction of the positive $Z$-axis.
\index{local axes}
\index{global axes}
The initial local axes $(x, y, s)$ coincide with the global axes
$(X, Y, Z)$ in this order.
The six quantities
$(X_{0}, Y_{0}, Z_{0}, \theta_{0}, \phi_{0}, \psi_{0}),$
thus all have zero initial values by default.
The program user may however specify different initial conditions.

Internally the displacement is described by a vector $V$,
\index{displacement}
\index{orientation}
and the orientation by a unitary matrix $W$.
The {\em column vectors} of $W$ are the unit vectors spanning
the local coordinate axes in the order $(x, y, s)$.
$V$ and $W$ have the values
\[
V=\left(\myarray{
   X \\
   Y \\
   Z
}\right),
\qquad
W=\Theta\Phi\Psi,
\]
where
\[
\Theta=\left(\myarray{
   \cos\theta &  0 &  \sin\theta \\
     0         &  1 &   0 \\
   -\sin\theta &  0 &  \cos\theta
}\right), \quad
\Phi=\left(\myarray{
    1 &  0        &  0 \\
    0 &  \cos\phi &  \sin\phi \\
    0 & -\sin\phi &  \cos\phi
}\right), \quad
\Psi=\left(\myarray{
    \cos\psi & -\sin\psi &  0 \\
    \sin\psi &  \cos\psi &  0 \\
    0        &  0        &  1
}\right).
\]
The reference orbit should be closed and it should not be twisted.
This means that the displacement of the local reference system
must be periodic with the revolution frequency of the accelerator,
while the position angles must be periodic (modulo $2\pi$)
with the revolution frequency.
If $\psi$ is not periodic (modulo $2\pi$),
coupling effects are introduced.
When advancing through a beam element,
MAD computes $V_{i}$ and $W_{i}$
by the recurrence relations
\[
V_{i}=W_{i-1}R_{i}+V_{i-1}, \qquad
W_{i}=W_{i-1}S_{i}.
\]
The vector $R_{i}$ is the displacement and the matrix $S_{i}$ is
the rotation of the local reference system at the exit of the
element~$i$ with respect to the entrance of the same element. 
The values of $R$ and $S$ are listed below for each physical element
type. 

\section{Single Elements}

\subsection{Markers}
\index{MARKER}
Marker elements do not affect the reference orbit.
They are ignored for geometry calculations.

\subsection{Straight Elements}
The reference system for all straight elements is shown in
Figure~\ref{F-DRF}.
It is valid for:

\indent\begin{tabular}{llll}
$\bullet$ \tt DRIFT \index{drift} &
$\bullet$ \tt RCOLLIMATOR \index{collimator} &
$\bullet$ \tt ECOLLIMATOR &
$\bullet$ \tt INSTRUMENT \index{instrument} \\
$\bullet$ \tt MONITOR \index{monitor} &
$\bullet$ \tt HMONITOR \index{drift} &
$\bullet$ \tt VMONITOR \index{drift} &
$\bullet$ \tt QUADRUPOLE \index{quadrupole} \\
$\bullet$ \tt SEXTUPOLE \index{sextupole} &
$\bullet$ \tt OCTUPOLE \index{octupole} &
$\bullet$ \tt SOLENOID \index{solenoid} &
$\bullet$ \tt RFCAVITY \index{RF cavity} \index{cavity} \\
$\bullet$ \tt ELSEPARATOR \index{separator}
\index{electrostatic separator} &
$\bullet$ \tt KICKER \index{corrector} &
$\bullet$ \tt HKICKER &
$\bullet$ \tt VKICKER \\
$\bullet$ \tt MONITOR \index{monitor} &
$\bullet$ \tt HMONITOR &
$\bullet$ \tt VMONITOR \\
\end{tabular}

\begin{figure}[ht]
\centering
\setlength{\unitlength}{1pt}
\begin{picture}(400,100)
\thinlines
% axes
\put(150,50){\circle{8}}\put(150,50){\circle*{2}}
\put(140,40){\makebox(0,0){$y_1$}}
\put(250,50){\circle{8}}\put(250,50){\circle*{2}}
\put(260,40){\makebox(0,0){$y_2$}}
\put(100,50){\line(1,0){46}}
\put(154,50){\line(1,0){92}}
\put(254,50){\vector(1,0){46}}
\put(290,40){\makebox(0,0){$s$}}
\put(150,0){\line(0,1){46}}
\put(150,54){\vector(0,1){46}}
\put(140,90){\makebox(0,0){$x_1$}}
\put(250,0){\line(0,1){46}}
\put(250,54){\vector(0,1){46}}
\put(260,90){\makebox(0,0){$x_2$}}
% magnet outline
\thicklines
\put(150,54){\line(0,1){26}}
\put(150,46){\line(0,-1){26}}
\put(250,54){\line(0,1){26}}
\put(250,46){\line(0,-1){26}}
\put(150,20){\line(1,0){100}}
\put(150,80){\line(1,0){100}}
\put(200,2){\vector(1,0){50}}
\put(200,2){\vector(-1,0){50}}
\put(200,10){\makebox(0,0){L}}
\end{picture}
\caption{Reference System for Straight Beam Elements}
\label{F-DRF}
\end{figure}

\noindent The corresponding $R$ and $S$ are
\[
   R=\left(\myarray{
      0 \\
      0 \\
      L
   }\right),
   \qquad
   S=\left(\myarray{
      1 & 0 & 0 \\
      0 & 1 & 0 \\
      0 & 0 & 1 \\
   }\right).
\]
A rotation of the {\em element} about the $s$-axis has an effect
on $R$ and $S$ only for dipoles,
since for all other elements the rotations of the reference system
before and after the element cancel.

\subsection{Dipoles}
\index{bending magnet}
\index{dipole}
Bending magnets affect the reference orbit due to their curvature.
For both rectangular and sector bending magnets
\[
   R=\left(\myarray{
      \rho(\cos\alpha-1) \\
      0 \\
      \rho\sin\alpha
   }\right),
   \qquad
   S=\left(\myarray{
       \cos\alpha & 0 & -\sin\alpha \\
       0          & 1 &  0 \\
       \sin\alpha & 0 &  \cos\alpha
   }\right),
\]
where $\alpha$ is the bend angle.
A positive bend angle represents a bend to the right,
i.e. towards negative $x$ values.
For sector bending magnets,
the bend radius is given by $\rho=L/\alpha$,
and for rectangular bending magnets it has the value
$\rho=L/(2\sin(\alpha/2))$.

The reference system for type \ttindex{SBEND} is shown in
Figure~\ref{F-SBND},
for type \ttindex{RBEND} it is shown in Figure~\ref{F-RBND}.

\begin{figure}[ht]
\centering
\setlength{\unitlength}{1pt}
\begin{picture}(400,215)
% axes
\thinlines
\put(150,150){\circle{8}}\put(150,150){\circle*{2}}
\put(160,140){\makebox(0,0){$y_1$}}
\put(250,150){\circle{8}}\put(250,150){\circle*{2}}
\put(240,140){\makebox(0,0){$y_2$}}
\put(74,124.7){\vector(3,1){72}}
\put(84,135){\makebox(0,0){$s_1$}}
\put(254,148.7){\vector(3,-1){72}}
\put(316,135){\makebox(0,0){$s_2$}}
\put(200,0){\vector(-1,3){48.7}}
\put(165,75){\makebox(0,0){$\rho$}}
\put(148.7,154){\vector(-1,3){18}}
\put(118,206){\makebox(0,0){$x_1$}}
\put(200,0){\vector(1,3){48.7}}
\put(235,75){\makebox(0,0){$\rho$}}
\put(251.3,154){\vector(1,3){18}}
\put(282,206){\makebox(0,0){$x_2$}}
\bezier{20}(190.5,28.5)(200,31.7)(209.5,28.5)
\put(200,20){\makebox(0,0){$\alpha$}}
\put(154,150){\line(1,0){92}}
\put(200,150){\circle*{4}}
\put(200,150){\vector(0,1){60}}
\put(210,200){\makebox(0,0){$x$}}
\put(150,154){\line(0,1){44}}
\put(150,146){\line(0,-1){46}}
\put(151,154){\line(1,4){11}}
\put(250,154){\line(0,1){44}}
\put(250,146){\line(0,-1){46}}
\put(249,154){\line(-1,4){11}}
% magnet outline
\thicklines
\put(200,102){\vector(-1,0){50}}
\put(200,102){\vector(1,0){50}}
\put(200,110){\makebox(0,0){L}}
\put(151,154){\line(1,4){6}}
\put(149,146){\line(-1,-4){6}}
\put(249,154){\line(-1,4){6}}
\put(251,146){\line(1,-4){6}}
\put(157,178){\line(1,0){86}}
\put(143,122){\line(1,0){114}}
\bezier{10}(150,195)(155.5,195)(160.9,193.7)
\put(155.5,195){\vector(3,-1){5.4}}
\put(150,205){\makebox(0,0)[l]{$e_1$}}
\bezier{10}(250,195)(244.5,195)(239.1,193.7)
\put(244.5,195){\vector(-3,-1){5.4}}
\put(250,205){\makebox(0,0)[r]{$e_2$}}
\end{picture}
\caption[Reference System for a Rectangular Bending Magnet]%
{Reference System for a Rectangular Bending Magnet;
the signs of pole-face rotations are positive as shown.}
\label{F-RBND}
\end{figure}

\begin{figure}[ht]
\centering
\setlength{\unitlength}{1pt}
\begin{picture}(400,215)
% axes
\thinlines
\put(150,150){\circle{8}}\put(150,150){\circle*{2}}
\put(160,140){\makebox(0,0){$y_1$}}
\put(250,150){\circle{8}}\put(250,150){\circle*{2}}
\put(240,140){\makebox(0,0){$y_2$}}
\put(74,124.7){\vector(3,1){72}}
\put(84,135){\makebox(0,0){$s_1$}}
\put(254,148.7){\vector(3,-1){72}}
\put(316,135){\makebox(0,0){$s_2$}}
\put(200,0){\vector(-1,3){48.7}}
\put(165,75){\makebox(0,0){$\rho$}}
\put(148.7,154){\vector(-1,3){18}}
\put(118,206){\makebox(0,0){$x_1$}}
\put(200,0){\vector(1,3){48.7}}
\put(235,75){\makebox(0,0){$\rho$}}
\put(251.3,154){\vector(1,3){18}}
\put(282,206){\makebox(0,0){$x_2$}}
\bezier{20}(190.5,28.5)(200,31.7)(209.5,28.5)
\put(200,20){\makebox(0,0){$\alpha$}}
\put(200,158.8){\circle*{4}}
\put(200,158.8){\vector(0,1){50}}
\put(210,200){\makebox(0,0){$r$}}
\put(151,154){\line(1,4){10}}
\put(249,154){\line(-1,4){10}}
% magnet outline
\thicklines
\bezier{100}(154,151.3)(200,166.7)(246,151.3)
\put(162,154){\vector(-3,-1){8}}
\put(238,154){\vector(3,-1){8}}
\put(210,168){\makebox(0,0){L}}
\put(151,154){\line(1,4){6}}
\put(149,146){\line(-1,-4){6}}
\put(249,154){\line(-1,4){6}}
\put(251,146){\line(1,-4){6}}
\bezier{90}(157,178)(200,188.4)(243,178)
\bezier{110}(143,122)(200,148.6)(257,122)
\bezier{20}(137.4,187.9)(149.1,191.5)(159.7,188.8)
\put(153.7,190.8){\vector(3,-1){6}}
\put(150,180){\makebox(0,0){$e_1$}}
\bezier{20}(262.6,187.9)(250.9,191.5)(240.3,188.8)
\put(246.3,190.8){\vector(-3,-1){6}}
\put(250,180){\makebox(0,0){$e_2$}}
\end{picture}
\caption[Reference System for a Sector Bending Magnet]%
{Reference System for a Sector Bending Magnet;
the signs of pole-face rotations are positive as shown.}
\label{F-SBND}
\end{figure}

If the magnet is rotated about the $s$-axis by an angle $\psi$,
$R$ and $S$ are transformed by
\[
   \overline{R}=TR,
   \qquad
   \overline{S}=TST^{-1}
\]
where $T$ is the rotation matrix
\[
   T=\left(\myarray{
       \cos\psi & -\sin\psi &  0 \\
       \sin\psi &  \cos\psi &  0 \\
       0        &  0        &  1 \\
   }\right).
\]
The special value $\psi=\pi/2$ represents
a bend down.

\subsection{Rotation of Reference System about $s$-Axis}
\index{rotation}
\index{reference system}
The reference system for the \ttindex{SROT} element which  rotates the
local reference system about the longitudinal axis is shown in
Figure~\ref{F-SROT}.
{\tt SROT} has no effect on the beam,
but it causes the beam to be referred to the new coordinate system
\[
x_{2}=x_{1} \cos\psi + y_{1} \sin\psi,
\qquad
y_{2}=x_{1} \sin\psi + y_{1} \cos\psi.
\]
A positive angle means that the new reference system is rotated clockwise
about the $s$-axis with respect to the old system.
The {\em reference system} is changed using
\[
R = \left( \myarray{ 0 \\ 0 \\ 0 } \right), \qquad
S = \left( \myarray{
    \cos\psi & -\sin\psi &  0 \\
    \sin\psi &  \cos\psi &  0 \\
    0        &  0        &  1 \\
} \right).       
\]

\subsection{Rotation of Reference System about $y$-Axis}
The reference system for a rotation by an angle~$\theta$
about the vertical axis (\ttindex{YROT})
the reference system is shown in Figure~\ref{F-YROT}.
{\tt YROT} has no effect on the beam,
but it causes the beam to be referred to the new coordinate system
\[
x_{2}=x_{1} \cos\theta - s_{1} \sin\theta,
\qquad
s_{2}=x_{1} \sin\theta + s_{1} \cos\theta.
\]
A positive angle rotates the reference system clockwise about the
local $y$-axis with respect to the old system:
\[
R = \left( \myarray{ 0 \\ 0 \\ 0 } \right), \qquad
S = \left(\myarray{
    \cos\theta &  0 & -\sin\theta \\
    0          &  1 &  0 \\
    \sin\theta &  0 &  \cos\theta
} \right).
\]

\begin{figure}[ht]
\centering
\setlength{\unitlength}{1pt}
\begin{picture}(400,200)
\thinlines
\put(200,100){\circle{8}}\put(200,100){\circle*{2}}
\put(190,90){\makebox(0,0){$s$}}
\put(100,100){\line(1,0){96}}
\put(204,100){\vector(1,0){96}}
\put(290,90){\makebox(0,0){$x_1$}}
\put(200,0){\line(0,1){96}}
\put(200,104){\vector(0,1){96}}
\put(190,210){\makebox(0,0){$y_1$}}
\put(103,75.75){\line(4,1){93}}
\put(204,101){\vector(4,1){93}}
\put(287,134){\makebox(0,0){$x_2$}}
\put(224.25,3){\line(-1,4){23.25}}
\put(199,104){\vector(-1,4){23.25}}
\put(166,187){\makebox(0,0){$y_2$}}
\bezier{20}(260,100)(260,107.5)(258,114.5)
\put(260,106.5){\vector(-1,4){2}}
\put(250,106.25){\makebox(0,0){$\psi$}}
\put(220,150){\circle{8}}\put(220,150){\circle*{2}}
\put(220,140){\makebox(0,0){beam}}
\end{picture}
\caption{Reference System for a Rotation Around the s-Axis}
\label{F-SROT}
\end{figure}
 
\begin{figure}[ht]
\centering
\setlength{\unitlength}{1pt}
\begin{picture}(400,200)
\thinlines
\put(200,100){\circle{8}}\put(200,100){\circle*{2}}
\put(190,90){\makebox(0,0){$y$}}
\put(100,100){\line(1,0){96}}
\put(204,100){\vector(1,0){96}}
\put(290,110){\makebox(0,0){$s_1$}}
\put(200,0){\line(0,1){96}}
\put(200,104){\vector(0,1){96}}
\put(190,190){\makebox(0,0){$x_1$}}
\put(103,124.25){\line(4,-1){93}}
\put(204,99){\vector(4,-1){93}}
\put(287,66){\makebox(0,0){$s_2$}}
\put(175.75,3){\line(1,4){23.25}}
\put(201,104){\vector(1,4){23.25}}
\put(234,187){\makebox(0,0){$x_2$}}
\bezier{20}(260,100)(260,92.5)(258,85.5)
\put(260,93.5){\vector(-1,-4){2}}
\put(250,93.75){\makebox(0,0){$\theta$}}
\thicklines
\put(100,130){\vector(1,0){200}}
\put(290,140){\makebox(0,0){beam}}
\end{picture}
\caption{Reference System for a Rotation Around the y-Axis}
\label{F-YROT}
\end{figure}

\section{Sequences of Elements}
\label{surseq}
The displacement and rotation of the reference system due to an
element sequence can be accumulated by the recurrence relations given
above:
\[
V_{i}=W_{i-1}R_{i}+V_{i-1}, \qquad
W_{i}=W_{i-1}S_{i}, \qquad i = 1 \ldots n.
\]
Accumulating these quantities in {\em beam order} one finds for the
sequence the values
\[
R = V_{n}, \qquad S = W_{n}.
\]

% ====================================================================

\chapter{Linear Optics}

The methods used for commands like \ttindex{TWISS} and
\ttindex{OPTICS} are described
in~\cite{SLAC75,CHA79,COU58,PEG81,TEN71,MAI82}.
In all these commands MAD uses TRANSPORT maps except for thin
multipoles, where the exact thin multipole maps are used.
When the closed orbit deviates from the design orbit,
it takes the Jacobian of the TRANSPORT map for the linear transfer
matrix.
For thick elements this may perturb the symplecticity of the map.
For this reason the Jacobian is by default symplectified according to
Section~\ref{symplectify}.
Symplectification is controlled by the option \ttindex{SYMPLEC}.

\section{Optical Functions}

\subsection{Conventions}
By default the \ttindex{TWISS} and \ttindex{OPTICS} commands track the
lattice functions for periodic initial conditions.
In this case any initial conditions specified
(except for~$\beta_x$ and~$\beta_y$)
override the periodic initial conditions. 
However, if an initial condition is specified for at least one
of $\beta_x$ and $\beta_y$, the closed orbit is not computed, and MAD
tracks the lattice functions for the initial conditions specified.
Unspecified initial conditions are set to zero in this case.

Unwary users may fool MAD into thinking that a value has been given
for~$\beta_x$.
The most frequent case is entering the {\tt CENTRE} flag on an
{\tt OPTICS} command in the American spelling:
\myxmp{OPTICS, CENTER ! should read OPTICS, CENTRE}
The decoder assumes in this case that \ttindex{CENTER} is the name of an
undefined global parameter, sets it to zero, and stores it in the slot
for the initial value of~$\beta_x$.

In MAD lattice functions are always computed with respect to the
computed closed orbit.
Two methods are used,
their choice depends on the command used and on the setting of the
\ttindex{COUPLE} option.
The first method, used in \ttindex{OPTICS} and by default in
\ttindex{TWISS}, ignores coupling between degrees of freedom and is
described in Section~\ref{beta}.

The second method,
used in \ttindex{TWISS} when the \ttindex{COUPLE} flag is set,
considers coupling between transverse modes and is described in
Section~\ref{couple}.
Both methods take ``sawtoothing'' of the energy due to synchrotron
radiation and RF~Cavities into account,
but they both ignore any synchro-betatron coupling.

\section{Dispersion}
MAD computes the dispersion only for static machines,
i.~e. for machines whose transfer map does not change the energy.

\subsection{Initial Values for Dispersion}
Knowing the TRANSPORT map with respect to the closed orbit for one
turn enables us to find two derivatives of the closed orbit with
respect to $\delta$, named the first- and second-order dispersions.
The first derivative of the closed orbit
\[
Z_0 = \left ( \myarray{
   x_0 \\ p_{x0} \\ y_0 \\ p_{y0} \\ c \cdot t_0 \\ \delta
} \right ),
\]
with respect to $\delta$ is the first-order dispersion:
\[
D^{(1)} = \left ( \myarray{
   \partial x/\partial\delta \\
   \partial p_x/\partial\delta \\
   \partial y/\partial\delta \\
   \partial p_y/\partial\delta \\
   0 \\
   \partial\delta/\partial\delta
} \right ) = \left ( \myarray{
   Dx \\ Dp_x \\ Dy \\ Dp_y \\ 0 \\ 1
} \right ) = \left ( \myarray{
   D^{(1)}_1 \\ D^{(1)}_2 \\ D^{(1)}_3 \\ D^{(1)}_4 \\ D^{(1)}_5 \\ D^{(1)}_6
} \right ).
\]
The second derivative of the closed orbit with respect to $\delta$ is
the second-order dispersion:
\[
D^{(2)} = \left ( \myarray{
   \partial^2 x/\partial\delta^2 \\
   \partial^2 p_x/\partial\delta^2 \\
   \partial^2 y/\partial\delta^2 \\
   \partial^2 p_y/\partial\delta^2 \\
   0 \\
   0
} \right ) = \left ( \myarray{
   DDx \\ DDp_x \\ DDy \\ DDp_y \\ 0 \\ 1
} \right ) = \left ( \myarray{
   D^{(2)}_1 \\ D^{(2)}_2 \\ D^{(2)}_3 \\ D^{(2)}_4 \\ D^{(2)}_5 \\ D^{(2)}_6
} \right ) 
\]
The dispersions are computed following a method developed
in~\cite{PEG81}.
With respect to the closed orbit the orbit behaves as
\[
Z - D^0 = \delta \cdot D^{(1)} + \frac{\delta^2}{2} \cdot D^{(2)} +
o(\delta^3)
\]
The vectors $D^{(1)}$ and $D^{(2)}$ can be found by substitution of this
expression in the TRANSPORT map and by separation of like powers
of~$\delta$.
Substitution yields
\[\eqarray{
\delta\cdot D^{(1)}_k+\frac{\delta^2}{2}\cdot D^{(2)}_k = \\
  = \sum_{\ell=1}^6 R_{k\ell}
    (\delta\cdot D^{(1)}_\ell+\frac{\delta^2}{2}\cdot D^{(2)}_\ell)+
  \sum_{\ell=1}^6 \sum_{m=1}^6 T_{k\ell m}
    (\delta\cdot D^{(1)}_\ell+\frac{\delta^2}{2}\cdot D^{(2)}_\ell)
    (\delta\cdot D^{(1)}_m+\frac{\delta^2}{2}\cdot D^{(2)}_m)+
  o(\delta^3).
}\]
The terms in $\delta$ yield:
\[
D^{(1)}_k = \sum_{\ell=1}^6 R_{k\ell} D^{(1)}_\ell
\]
Using $D^{(1)}_6=1$ and defining
\[
A = \left ( \myarray{
R_{11} & R_{12} & R_{13} & R_{14} \\
R_{21} & R_{22} & R_{23} & R_{24} \\
R_{31} & R_{32} & R_{33} & R_{34} \\
R_{41} & R_{42} & R_{43} & R_{44} \\
} \right ),
\]
we obtain
\[
\left ( \myarray{ D^{(1)}_1 \\ D^{(1)}_2 \\ D^{(1)}_3 \\ D^{(1)}_4} \right ) =
(A - I)^{-1} 
\left ( \myarray{ R_{16} \\ R_{26} \\ R_{36} \\ R_{46}} \right ).
\]
The terms in $\delta^2$ give
\[
D^{(2)}_k = \sum_{\ell=1}^6 R_{k\ell} D^{(2)}_\ell +
  2 \sum_{\ell=1}^6 \sum_{m=1}^6 T_{k\ell m} D^{(1)}_\ell D^{(1)}_m
\]
yielding
\[
\left ( \myarray{ D^{(2)}_1 \\ D^{(2)}_2 \\ D^{(2)}_3 \\ D^{(2)}_4} \right ) =
2 (A - I)^{-1} \left ( \myarray{
  \sum_{\ell=1}^6 \sum_{m=1}^6 T_{1\ell m} D^{(1)}_\ell D^{(1)}_m \\
  \sum_{\ell=1}^6 \sum_{m=1}^6 T_{2\ell m} D^{(1)}_\ell D^{(1)}_m \\
  \sum_{\ell=1}^6 \sum_{m=1}^6 T_{3\ell m} D^{(1)}_\ell D^{(1)}_m \\
  \sum_{\ell=1}^6 \sum_{m=1}^6 T_{4\ell m} D^{(1)}_\ell D^{(1)}_m
} \right ).
\]

\subsection{Tracking the Dispersion}
The first-order dispersion track through an element as follows:
\[
D^{(1)} \Leftarrow R D^{(1)}.
\]
By differentiation we find for the second-order dispersion:
\[
D^{(2)} \Leftarrow R D^{(2)} + R' D^{(1)}.
\]
The total derivative~$R'$ of the transfer matrix must take into account the
displacement of the orbit due to the dispersion.
The particle orbit can be related to the dispersion orbit $D^{(1)}$ by
$Z_{\rm tot} = \delta \cdot D^{(1)} + Z$.
It transforms according to the equation
\[
\delta \cdot D^{(1)}_k + Z^{(2)}_k \Leftarrow
  \sum_{\ell=1}^6 R_{k\ell} (\delta \cdot D^{(1)}_\ell + Z^{(1)}_\ell) +
  \sum_{\ell=1}^6 \sum_{m=1}^6 T_{k\ell m}
    (\delta \cdot D^{(1)}_\ell + Z^{(1)}_\ell)
    (\delta \cdot D^{(1)}_m + Z^{(1)}_m).
\]
The orbit with respect to the dispersion orbit transforms as
\[
Z^{(2)}_k = \sum_{\ell=1}^6 R_{k\ell} Z^{(1)}_\ell +
  \sum_{\ell=1}^6 \sum_{m=1}^6 T_{k\ell m} Z^{(1)}_\ell Z^{(1)}_m +
  2 \delta \sum_{\ell=1}^6 \sum_{k=1}^6 T_{k\ell m} D^{(1)}_\ell Z^{(1)}_m
\]
The total derivative of the transfer matrix is found by partial
differentiation as
\[
R' = \frac{dR_{k\ell}}{d\delta} = 2 \sum_{m=1}^6 T_{k\ell m} D^{(1)}_m.
\]

\section{Courant-Snyder Lattice Functions}
\label{beta}

\subsection{Initial Conditions for the Periodic Case}

When the \ttindex{COUPLE} option is not set, MAD computes the lattice
functions as defined in~\cite{COU58}.
Refer to Section~\ref{diff} for differences with other programs.
Note that the integer parts of the betatron phases may be wrong when a
beam line contains \ttindex{LUMP}~elements, or when it contains
negative element lengths.  In these cases wrong branch of the
arctangent function may be taken. 

For the functions $\beta,\alpha,\mu$ MAD uses the relevant diagonal
blocks of the transfer matrix, denoted below as
\[
R = \left ( \myarray{R_{11} & R_{12} \\ R_{21} & R_{22}} \right )
\]
For optimal numeric precision MAD uses the following formulas
for the tunes:
\[\eqarray{
\cos\mu  &= &(R_{11}+R_{22})/2,\\
\sin\mu  &= &\sign R_{12} \cdot
            \sqrt{R_{12}R_{21}-(R_{11}-R_{22})^2/4},\\
Q        &= &\frac{1}{2\pi} \arctan \frac{\sin\mu}{\cos\mu} \\
}\]
and the following for the initial lattice functions:
\[\eqarray{
\beta_0  &= &R_{12}/\sin\mu,\\
\alpha_0 &= &(R_{11}-R_{22})/(2\sin\mu).
}\]
The way $\sin\mu$ is computed greatly improves the precision for~$\mu$
when its value is close to $1/2$.

\subsection{Tracking the Lattice Functions}

The formulas for advancing through an element are well known:
\[\eqarray{
\beta_2  &=&\frac{1}{\beta_1}
  [(R_{11}\beta_1-R_{12}\alpha_1)^2+R_{12}^2], \\
\alpha_2 &=&-\frac{1}{\beta_1}
  [(R_{11}\beta_1-R_{12}\alpha_1)(R_{21}\beta_1-R_{22}\alpha_1)+
   R_{12}R_{22}], \\
\mu_2    &=&\mu_1+\arctan\frac{R_{12}}{R_{11}\beta_1-R_{12}\alpha_1}.
}\]
They are valid for both planes.

\section{Chromatic Effects (Uncoupled Case only)}

\subsection{Derivative of the Transfer Matrix w.r.t. Energy Error}

The total derivative of the transfer matrix with respect to the energy
error is required for the computation of chromatic effects.
It must take into account the displacement of the orbit due to the
dispersion.
The particle orbit can be related to the dispersion orbit $D^{(1)}$ by
$Z_{\rm tot} = \delta \cdot D^{(1)} + Z$.
It transforms according to the equation
\[
\delta \cdot D^{(1)}_k + Z^{(2)}_k =
  \sum_{\ell=1}^6 R_{k\ell} (\delta \cdot D^{(1)}_\ell + Z^{(1)}_\ell) +
  \sum_{\ell=1}^6 \sum_{m=1}^6 T_{k\ell m}
    (\delta \cdot D^{(1)}_\ell + Z^{(1)}_\ell)
    (\delta \cdot D^{(1)}_m + Z^{(1)}_m).
\]
Hence the orbit with respect to the dispersion orbit transforms as
\[
Z^{(2)}_k = \sum_{\ell=1}^6 R_{k\ell} Z^{(1)}_\ell +
 \delta \sum_{k=1}^6 \sum_{\ell=1}^6 T_{k\ell m} D^{(1)}_\ell Z^{(1)}_m.
\]
The total derivative of the transfer matrix is found by partial
differentiation as
\[
R' = \frac{dR_{k\ell}}{d\delta} = 2 \sum_{m=1}^6 T_{k\ell m} D^{(1)}_m.
\]

\subsection{Initial Values for Chromatic Functions}
\label{CHROM}
Using the total derivative of the transfer matrix for one turn we find
the following equations:
\[\eqarray{
\frac{1}{2}(R'_{11}+R'_{22})&=&\frac{d}{d\delta}(\cos\mu)&=&-\mu'\sin\mu,\\
R'_{12}&=&\frac{d}{d\delta}(\beta\sin\mu)&=&\beta'\sin\mu-\beta\mu'\cos\mu,\\
\frac{1}{2}(R'_{11}-R'_{22})&=&\frac{d}{d\delta}(\alpha\sin\mu)&=&
\alpha'\sin\mu-\alpha\mu'\cos\mu.\\
}\]
From these we derive the chromaticity
\[\eqarray{
\mu'   &=&\frac{R'_{11}+R'_{22}}{2\sin\mu},\\
Q'     &=&\frac{\mu'}{2\pi},\\
}\]
and the initial values for the chromatic functions
\[\eqarray{
\beta'_0 &=&\frac{R'_{12}+\beta_0\mu'\cos\mu}{\sin\mu},\\
\alpha'_0&=&\frac{R'_{11}-R'_{22}+2\alpha_0\mu'\cos\mu}{2\sin\mu},\\
B_0      &=&\frac{\beta'_0}{\beta_0},\\
A_0      &=&\frac{\alpha_0'\beta_0-\beta'_0\alpha_0}{\beta_0},\\
W_0      &=&\sqrt{B_0^2+A_0^2},\\
\Phi_0   &=&\arctan\frac{A_0}{B_0}.
}\]

\subsection{Tracking the Chromatic Functions}

The derivative of the phase advance by~$\delta$ is found easily:
\[
\mu'_2=\frac{d\mu_2}{d\delta}=\mu'_1+
  \frac{(R_{11}R'_{12}-R_{12}R'_{11})\beta_1-
        R_{12}(R_{11}\beta'-R_{12}\alpha')}
       {(R_{11}\beta-R_{12}\alpha)^2+R_{P12}^2}.
\]
Given the values~$W_1$ and~$\Phi_1$ one may write
\[\eqarray{
A_1      &=&W_1\cos\Phi_1,\\
B_1      &=&W_1\sin\Phi_1,\\
\beta'_1 &=&B_1\beta_1,\\
\alpha'_1&=&A_1+B_1\alpha_1,\\
B_2      &=&\frac{1}{\beta_1\beta_2}\biggl(
            \Bigl(\bigl(R_{11}\beta_1-R_{12}\alpha_1\bigr)^2-R_{12}^2\Bigr)B_1-
                  2\bigl(R_{11}\beta_1-R_{12}\alpha_1\bigr)R_{12}A_1\biggr)\\
         &+&\frac{2}{\beta_2}\Bigl(
            \bigl(R_{11}\beta_1-R_{12}\alpha_1\bigr)R'_{11}-
            \bigl(R_{11}\alpha_1-R_{12}\gamma_1\bigr)R'_{12}\Bigr),\\
A_2      &=&\frac{1}{\beta_1\beta_2}\biggl(
            \Bigl(\bigl(R_{11}\beta_1-R_{12}\alpha_1\bigr)^2-R_{12}^2\Bigr)A_1+
                  2\bigl(R_{11}\beta_1-R_{12}\alpha_1\bigr)R_{12}B_1\biggr)\\
         &-&\frac{1}{\beta_2}\Bigl(
                  \bigl(R_{11}\beta_1-R_{12}\alpha_1\bigr)
                  \bigl(R'_{11}\alpha_2+R'_{21}\beta_2\bigr)-
                  \bigl(R_{11}\alpha_1-R_{12}\gamma_1\bigr)
                  \bigl(R'_{12}\alpha_2+R'_{22}\beta_2\bigr)+
                  \bigl(R_{11}R'_{12}-R_{12}R'_{11}\bigr)\Bigr),\\
W_2      &=&\sqrt{B_2^2+A_2^2},\\
\Phi_2   &=&\arctan\frac{A_2}{B_2}.\\
}\]
Note that the ``partial'' chromaticity $\mu'_2-\mu'_1$ for a piece of
the ring depends not only on the transfer map, but also on the initial
values~$\beta'_1$ and~$\alpha'_1$.

\section{Transverse Coupling}
\label{couple}

\subsection{Initial Values for Edward-Teng Functions}

When the \ttindex{COUPLE} option is set, the \ttindex{TWISS} command
uses a method similar to reference~\cite{TEN71}.
Consider the linear transfer map $\mathrm{\bf M}$ in {\em two}
degrees of freedom partitioned into four $2\times2$~blocks:
\[
\mathrm{\bf M}=\left(\myarray{
m_{11} & m_{12} & m_{13} & m_{14} \\
m_{21} & m_{22} & m_{23} & m_{24} \\
m_{31} & m_{32} & m_{33} & m_{34} \\
m_{41} & m_{42} & m_{43} & m_{44} \\
}\right) = \left(\myarray{A & B \\ C & D}\right).
\]
The 4-dimensional phase space vector shall also be partitioned
according to the horizontal and vertical planes.
Edwards and Teng introduce a ``symplectic rotation''
\[
\mathrm{\bf R}=\left(\myarray{
  I\cos\phi & \overline{R}\sin\phi \\ -R\sin\phi & I\cos\phi
}\right)
\]
$R$~is a $2 \times 2$~matrix with unit determinant,
and~$\overline{R}$ denotes its symplectic conjugate:
\[
R = \left( \myarray{ a & b \\ c & d } \right), \qquad
|R| = \left| \myarray{ a & b \\ c & d } \right| = 1, \qquad
\overline{R} = \left( \myarray{ d & -b \\ -c & a } \right ).
\]
This leaves three free parameters for the elements of $R$,
and a fourth parameter $\phi$.
Edwards and Teng then determine $\mathrm{\bf R}$ such
that~$\mathrm{\bf M}$ conjugated with~$\mathrm{\bf R}$ becomes block
diagonal:
\[
\mathrm{\bf R} \mathrm{\bf M} \mathrm{\bf R}^{-1} =
  \left( \myarray{ E & 0 \\ 0 & F } \right)
\]
If $|B + \overline{C}| < 0$ both $\phi$ and all elements of $R$ become
imaginary.
This may be avoided by redefining
\[
\mathrm{\bf R}=\frac{1}{\sqrt{1+|R|}}\left(\myarray{I&\overline{R}\\
  -R&I}\right).
\]
where all four elements of $R$ are free parameters.
The solutions is:
\[\eqarray{
R&=&-\left(\frac{1}{2}(\Tr A-\Tr D)+\sign(|B+\overline{C})
  \sqrt{|B + \overline{C}| + \frac{1}{4}(\Tr A - \Tr D)^2}\right)^{-1}
  \left(B + \overline{C}\right), \\
E &=& A - B R, \qquad
F = D + \overline{R} C.
}\]
The block diagonalized matrix can be parametrized as usual.
From the eigenvectors of the conjugated system
\[\eqarray{
V_1&=&\left(\myarray{\sqrt{\beta_1}&0\\
  \frac{\alpha_1}{\sqrt{\beta_1}}&\frac{1}{\sqrt{\beta_1}}}\right),\qquad
V_2&=&\left(\myarray{\sqrt{\beta_2}&0\\
  \frac{\alpha_2}{\sqrt{\beta_2}}&\frac{2}{\sqrt{\beta_2}}}\right)
}\]
one may find the eigenvectors of the coupled system:
\[\eqarray{
\mathrm{\bf V}_1&=&\frac{1}{\sqrt{1+|R|}}
\left(\myarray{V_1\\\overline{R}V_1}\right),\qquad
\mathrm{\bf V}_2&=&\frac{1}{\sqrt{1+|R|}}
\left(\myarray{-RV_2\\V_2}\right).
}\]

\subsection{Tracking the Edwards-Teng Functions}

For tracking the coupled lattice functions we assume that the
transfer matrix for one element is partitioned as above:
\[
\mathrm{\bf R}_e = \left( \myarray{ A_e & B_e \\ C_e & D_e } \right),
\]
The symplectic rotation at element entrance changes the diagonal
blocks to
\[
E_e = (A_e - B_e R_1) / \sqrt{|A_e - B_e R_1|}, \qquad
F_e = (D_e + \overline{R}_1 C_e) / \sqrt{|A_e - B_e R_1|}, \qquad
\]
and the new coupling matrix at exit becomes
\[
R_2 = - (C_e - D_e R_1) \overline{(A_e - B_e R_1)} / |A_e - B_e R_1|.
\]
We may track the decoupled lattice functions using the
matrices~$E_e$ for mode~1 and~$F_e$ for mode~2.

\section{Full Coupling: Linear Normal Form and Beam Envelope}
\label{EMNORM}
The eigenmode and beam envelope algorithms used in the
\ttindex{NORMAL}, \ttindex{EIGEN}, \ttindex{ENVELOPE}, and
\ttindex{TWISS3} commands are based on~\cite{DRA82,MAI82,RIP70}.
All these commands determine the closed orbit according to~\ref{s-co}.
They compute the one-turn transfer matrix around this orbit.
Then they track eigenmodes, beam envelopes or Mais-Ripken functions,
as described in the following subsections.

\subsection{Eigenvectors}
\label{EMEVGO}
A straightforward description of the three eigenmodes is contained in
the eigenvectors.
In the coupled case the one-turn transfer matrix $R(0,C)$ has three
complex eigenvectors
\[
V_k(0) = \left( \myarray{
v_{1,k} \\ v_{2,k} \\ v_{3,k} \\ v_{4,k} \\ v_{5,k} \\ v_{6,k}
} \right), \qquad k = 1, 2, 3.
\]
The eigenvectors are ordered such that the first one is mainly
horizontal, the second one mainly vertical, and the third one mainly
longitudinal.
They are normalized such that
\[
\sum_{m=1}^3 (\Re v_{2m-1,k} \Im v_{2m,k} - \Im v_{2m-1,k} \Re v_{2m,k}) = 1,
\qquad k = 1, 2, 3
\]
and rotated in the complex plane to make the $(2k-1)^{th}$ component
of the eigenvector~$V_k(0)$ real: $\Im v_{2k-1,k} = 0$,
i.~e. the initial phase of the principal projection is zero.
The real and imaginary parts of the eigenvectors, placed as columns in
a matrix, then form a symplectic matrix.
The general initial condition for the eigenmode $k$ is
\[
Z_k(0) = \Re ( V_k(0) \exp (- 2 \pi i \mu_k(0)) =
\Re V_k(0) \cos (2 \pi \mu_k(0)) + \Im V_k(0) \sin (2 \pi \mu_k(0)),
\qquad k = 1, 2, 3,
\]
where $\mu_k(0)$ is the initial \emindex{principal phase} for this mode.
The eigenvectors behave like ordinary trajectories,
thus they can be tracked by
\[
V_k(s) = R(s,0) V_k(0).
\]
The phase for the projection of mode~$i$ on plane~$k$ is
\[
\mu_{i,k}(s) = \arctan \frac{\Im v_{2k-1,i}}{\Re v_{2k-1,i}}.
\]
MAD prints the {\em principal} phase function
\[
\mu_{i} = \mu_{k,k}(s) =
\arctan \frac{\Im v_{2i-1,i}(s)}{\Re v_{2i-1,i}(s)}.
\]
Note that all three projections of an eigenmode have the same phase
advance $Q_k$ for one turn around the machine.
However, the projections of the eigenmode on the three planes need not
all start at the same phase.
Note also that the trajectory in a solenoid being helicoidal,
the projections on the transverse planes are in quadrature.
Thus the three projections are generally not in phase.

\subsection{Linear Normal Form}
A linear symplectic map in three degrees of freedom is represented by
its one-turn transfer matrix~$R(s,s+C)$.
Its normal form representation is
\[
R(s,s+C) = A(s) N A^{-1}(s),
\]
where the normalized matrix $N$
\[
N = \left( \myarray{
 \cos 2\pi Q_1 & \sin 2\pi Q_1 & 0 & 0 & 0 & 0 \\
-\sin 2\pi Q_1 & \cos 2\pi Q_1 & 0 & 0 & 0 & 0 \\
 0 & 0 &  \cos 2\pi Q_2 & \sin 2\pi Q_2 & 0 & 0 \\
 0 & 0 & -\sin 2\pi Q_2 & \cos 2\pi Q_2 & 0 & 0 \\
 0 & 0 & 0 & 0 &  \cos 2\pi Q_3 & \sin 2\pi Q_3 \\
 0 & 0 & 0 & 0 & -\sin 2\pi Q_3 & \cos 2\pi Q_3 \\
} \right),
\]
does not depend on $s$,
and the normalizing map~$A$ is periodic in $s$.
Its matrix is formed by the eigenvectors
\[
A(s) = \left( \myarray{
\Re v_{11}(s) & \Im v_{11}(s) & \Re v_{12}(s) & \Im v_{12}(s) &
\Re v_{13}(s) & \Im v_{13}(s) \\ 
\Re v_{21}(s) & \Im v_{21}(s) & \Re v_{22}(s) & \Im v_{22}(s) &
\Re v_{23}(s) & \Im v_{23}(s) \\ 
\Re v_{31}(s) & \Im v_{31}(s) & \Re v_{32}(s) & \Im v_{32}(s) &
\Re v_{33}(s) & \Im v_{33}(s) \\ 
\Re v_{41}(s) & \Im v_{41}(s) & \Re v_{42}(s) & \Im v_{42}(s) &
\Re v_{43}(s) & \Im v_{43}(s) \\ 
\Re v_{51}(s) & \Im v_{51}(s) & \Re v_{52}(s) & \Im v_{52}(s) &
\Re v_{53}(s) & \Im v_{53}(s) \\ 
\Re v_{61}(s) & \Im v_{61}(s) & \Re v_{62}(s) & \Im v_{62}(s) &
\Re v_{63}(s) & \Im v_{63}(s) \\ 
} \right) .
\]
As shown in the previous section, we have
\[
A(s) = R(0,s) A(0),
\]
and the phase for the projection of mode~$i$ on plane~$k$ is define as
above as
\[
\mu_{i,k}(s) = \arctan \frac{A_{2k-1,2i}}{A_{2k-1,2i-1}}.
\]

\subsection{Beam Envelopes}
\label{EMENGO}
According to~\cite{SLAC75} a Gaussian beam can be described by the
distribution
\[
N(Z) \propto \exp (\frac{1}{2} Z^T \Sigma^{-1} Z),
\]
where the matrix~$\Sigma$ is symmetric.
The standard deviation of~$z_k$ is
\[
\sigma_k = \sqrt{\Sigma_{kk}},
\]
and the correlations between~$z_k$ and~$z_m$ as
\[
r_{km} = \frac{\Sigma_{km}}{\sigma_k \sigma_m}.
\]
These formulas are also valid for each eigenmode, if
\[
\Sigma = \Re (V_k V_k^{*T}), \qquad V_k^* = \Re V_k - i \Im V_k.
\]
Given the emittances~$E_k$ for each mode,
the total beam envelope is represented as
\[
\Sigma = \sum_{k=1}^3 E_k \Re (V_k V_k^{*T}).
\]
When the \ttindex{BEAM} option is set on the \ttindex{NORMAL} command
MAD computes the beam sizes and correlations from this matrix.

\subsection{Mais-Ripken Lattice Functions}
\label{EMTWGO}
An alternate representation follows references~\cite{MAI82,RIP70}.
The projection of the Courant-Snyder lattice functions on the three
planes are:
\[\eqarray{
\beta_{i,k}  &=&v_{2k-1,2i-1}v_{2k-1,2i-1}&+&v_{2k-1,2i}v_{2k-1,2i},&\\
\gamma_{i,k} &=&v_{2k,  2i-1}v_{2k,  2i-1}&+&v_{2k,  2i}v_{2k,  2i},&
  \qquad k, i = 1, 2, 3. \\
\alpha_{i,k} &=&v_{2k-1,2i-1}v_{2k,  2i-1}&+&v_{2k,  2i}v_{2k-1,2i},&
}\]
Here the index~$i$ refers to the eigenmode, and the index~$k$ to the
plane.
When the \ttindex{TWISS} option is set on the \ttindex{NORMAL}
command,
MAD prints the functions~$\beta_{i,k}$ and~$\alpha_{i,k}$.
Note that we have the equation
\[
\beta_{i,k} \gamma_{i,k} - \alpha_{i,k}^2 = 
\left( \beta_{i,k} \frac{d \mu_{i,k}}{ds} \right)^2, \qquad
\hbox{\bf\rm but} \quad \beta_{i,k} \frac{d \mu_{i,k}}{ds} \neq 1,
\]
where~$\mu_{i,k}$ is the phase advance for the projection on
plane~$k$ of the eigenmode~$i$.

% ====================================================================

\chapter{``BM'' Module, Electron Beam Parameters}
***** section to be filled in *****

% ====================================================================

\chapter{``CO'' Module, Closed Orbit and Dispersion Correction}
\label{CO}
The {\tt CO}~module implements the commands related to closed orbit.
The data structures used are documented in the MAD Programmer's Manual.
Table~\ref{T-CO} shows which algorithms are documented here.

\begin{table}[h]
\centering
\caption{Routines in the {\tt CO}~module}
\label{T-CO}
\vspace{1ex}
\begin{tabular}{|l|p{0.7\textwidth}|c|}
\hline
Name&Purpose&Section\\
\hline
\tt COCORR&Command routine for {\tt CORRECT} command&-\\
\tt COGDIS&Fetch dispersion readings for a plane from table&-\\
\tt COGKIK&Fetch kicker strengths for a plane from table&-\\
\tt COGMON&Fetch monitor readings for a plane from table&-\\
\tt COLDIS&Orbit and dispersion correction by micado algorithm&
  \ref{COLDIS}\\
\tt COLORB&Orbit correction only by micado algorithm&\ref{COLORB}\\
\tt COMAIN&Switch routine for {\tt CO}~module&-\\
\tt COMICA&Command routine for {\tt MICADO} command&-\\
\tt COMDIS&Set up influence matrix for orbit and dispersion for
  a plane&\ref{COMDIS}\\
\tt COMORB&Set up influence matrix for orbit for a plane&\ref{COMORB}\\
\tt COPDIS&Print dispersion readings&-\\
\tt COPKIK&Print kicker strengths&-\\
\tt COPMON&Print orbit readings&-\\
\tt CORDIS&Command routine for {\tt GETDISP} command&-\\
\tt CORKIK&Command routine for {\tt GETKICK} command&-\\
\tt CORMON&Command routine for {\tt GETORBIT} command&-\\
\tt COSKIK&Increment kicker strengths for a plane in table&-\\
\tt COTBLE&Set up corrector and monitor table&\ref{COTBLE}\\
\tt COWDIS&Command routine for {\tt PUTDISP} command&-\\
\tt COWKIK&Command routine for {\tt PUTKICK} command&-\\
\tt COWMON&Command routine for {\tt PUTORBIT} command&-\\
\hline
\end{tabular}
\end{table}

\section{Orbit and dispersion correction by micado algorithm}
\label{COLDIS}
***** section to be filled in *****

\section{Orbit correction only by micado algorithm}
\label{COLORB}
***** section to be filled in *****

\section{Set up influence matrix for orbit and dispersion for a plane}
\label{COMDIS}
***** section to be filled in *****

\section{Set up influence matrix for orbit for a plane}
\label{COMORB}
***** section to be filled in *****

\section{Set up corrector and monitor table}
\label{COTBLE}
***** section to be filled in *****


% ====================================================================

\chapter{``EM'' Module, Emittance Calculations}
The routines of the ``EM''~module are listed in Table~\ref{T-EM}.
This table also refers to the sections where algorithms are
documented.

\begin{table}[h]
\centering
\caption{Routines in the {\tt EM}~module}
\label{T-EM}
\vspace{1ex}
\begin{tabular}{|l|p{0.7\textwidth}|c|}
\hline
Name&Purpose&Section\\
\hline
\tt EMCE2I&Convert eigenvectors to internal sigma matrix form&
  \ref{EMCE2I}\\
\tt EMCI2T&Convert beam matrix from internal to TRANSPORT form&
  \ref{EMCI2T}\\
\tt EMCT2I&Convert beam matrix from TRANSPORT to internal form&
  \ref{EMCT2I}\\
\tt EMDAMP&Calculate radiation damping in an element&
  \ref{EMDAMP}\\
\tt EMEMDO&Command routine for {\tt EMIT} command&-\\
\tt EMEMGO&Work routine for {\tt EMIT} command&\ref{EMDAMP}\\
\tt EMENDO&Command routine for {\tt ENVELOPE} command&-\\
\tt EMENGO&Work routine for {\tt ENVELOPE} command&\ref{EMENGO}\\
\tt EMENPR&Print beam sizes for {\tt ENVELOPE} command&-\\
\tt EMENSV&Save beam sizes for {\tt ENVELOPE} command&-\\
\tt EMEVDO&Command routine for {\tt EIGEN} command&-\\
\tt EMEVGO&Work routine for {\tt EIGEN} command&-\\
\tt EMEVPR&Print orbit and eigenvectors for {\tt EIGEN} command&-\\
\tt EMEVSV&Save orbit and eigenvectors for {\tt NORMAL} command&-\\
\tt EMINIT&Initialize radiation damping calculations&-\\
\tt EMNORM&Command routine for {\tt NORMAL} command&\ref{EMNORM}\\
\tt EMSSIG&Work routine for {\tt SAVESIGMA} command&-\\
\tt EMSUMM&Make summary calculations for radiation damping&-\\
\tt EMTWDO&Command routine for {\tt TWISS1} command&-\\
\tt EMTWGO&Work routine for {\tt TWISS1} command&\ref{EMTWGO}\\
\tt EMTWPR&Print Mais-Ripken betatron functions&-\\
\tt EMTWSV&Save Mais-Ripken functions for {\tt TWISS1} command&-\\
\hline
\end{tabular}
\end{table}

\section{Transformations between Representations of Beam}

\subsection{Eigenvectors to Internal Sigma}
\label{EMCE2I}
Given the eigenvectors and the emittances for the three eigenmodes the
beam ellipsoid $\Sigma$~\cite{SLAC75} can be computed as
\[
\Sigma = \left(\myarray{
\Sigma_{11} & \cdots & \Sigma_{14} \\
\vdots      &        & \vdots \\
\Sigma_{41} & \cdots & \Sigma_{44}
}\right) =
\sum_{k=1}^3 E_k \Re (V_k^T V_k^*).
\]
Assuming a Gaussian distribution, the particle distribution is then
\[
N(Z) \propto exp(\frac{1}{2} Z^T \Sigma^{-1} Z).
\]

\subsection{Internal Sigma to TRANSPORT}
\label{EMCI2T}
Given the $\Sigma$ matrix of the previous section the standard
deviation of~$z_k$ is~\cite{SLAC75}:
\[
\sigma_k = \sqrt{\Sigma_{kk}},
\]
and the correlations between~$z_k$ and~$z_m$ as
\[
r_{km} = \frac{\Sigma_{km}}{\sigma_k \sigma_m}.
\]
MAD prints beam envelopes in this form.

\subsection{TRANSPORT to Internal Sigma}
\label{EMCT2I}
The formulas of the previous section can be inverted as:
\[
\Sigma_{kk} = \sigma_k^2, \qquad k = 1 \ldots 4,
\]
and the off-diagonal elements are
\[
\Sigma_{km} = r_{km} \sigma_k \sigma_m, k, m = 1 \ldots 4, k \neq m.
\]
MAD uses this formula to find the internal $\Sigma$ matrix from a
\ttindex{SIGMA0} command.

\section{Synchrotron Radiation and Damping, Equilibrium Emittances}
\label{EMDAMP}
***** section to be filled in *****

\subsection{Energy Loss by Synchrotron Radiation in Lattice Elements}
***** section to be filled in *****

\subsection{Synchrotron Radiation Damping}
The algorithm for synchrotron radiation damping is based
on~\cite{CHA79}.
***** section to be filled in *****

\subsection{Quantum Excitation by Synchrotron Radiation}
***** section to be filled in *****

% ====================================================================

\chapter{``HA'' Module, Resonance Analysis}

The HARMON caluculations are based on a program originally written by
M.~Donald and later linked to MAD by D.~Schofield~\cite{DON82}.
Various changes and improvements have been made since in this module.

\section{General Organization of the Computations}
Computations in the HARMON module are based on a thin lens
approximation.
Integration over the ring is thus replaced by summation over the
elements, where the integrands are also approximated by evaluating
their factors from averaged lattice functions.
Note that integration over $\sqrt{\beta}$ is replaced by multiplying
the square root of the average~$\beta$ by the element length,
and that similar remarks apply to all other integrations.

When the HARMON module is started by the command \ttindex{HARMON},
it first sets up a table containing the averaged lattice functions for
all dipoles, quadrupoles, sextupoles, and thin multipoles.
The lattice functions ($\beta_x$, $\alpha_x$, $\mu_x$, $Dx$, $Dp_x$,
$DDx$, $DDp_x$, $\beta_y$, $\alpha_y$, $\mu_y$), averaged over each of
these elements are then stored in this table.
The output lists for elements show these {\em averaged functions}.

Double integrals are evaluated in an efficient way.
Addition theorems for trigonometric functions are applied and
functions of different positions are separated.
Then it is possible to evaluate a double integral as a double sum,
where the outer sum runs over partial sums of the inner sum.
Thus the double integral can be found in a single loop.
In a similar way the triple sums for triple integrals can be found.
Refer to details in the sections below.

\section{First-Order Chromaticity}
The linear chromaticity is found according to a formula given by
J\"ager and M\"ohl~\cite{JAE81}.
Defining
\[
D = \frac{\partial}{\partial\delta}, \qquad ' = \frac{d}{ds}
\]
the chromaticities can be written as:
\[\myarray{
DQ_x &=&
  \frac{1}{4 \pi} \left(
    - \int_0^C (K_1 + h^2) \beta_x ds
    + \int_0^C h Dx (2 K_1\beta_x + \gamma_x)
    - 2 \int_0^C h Dx' \alpha_x ds
    + \int_0^C K_2 Dx \beta_x ds
  \right), \\
DQ_y &=&
  \frac{1}{4 \pi} \left(
    + \int_0^C K_1 \beta_x ds 
    + \int_0^C h Dx (- K_1 \beta_y + \gamma_y) ds
    + \int_0^C h'Dx' \beta_y ds
    - \int_0^C K_2 Dx \beta_y ds
  \right), \hfill \\
}\]
These integrals are evaluated in \ttindex{HACHCL} by exact integration.
The results agree very well with the results found from
\ttindex{TWISS} (see\ref{CHROM}).
For small rings it is important that the term containing $h'$ is not
omitted.
To adjust the chromaticities to desired values the subroutine
\ttindex{HACFIT} varies two families of sextupoles such as to obtain
the desired values.

The second- and third-order chromaticities consider only the effects
of quadrupoles and higher-order multipoles.
They are found using the following integrals:
\[\myarray{
DDQ_x &=&
- \frac{1}{4 \pi} \int_0^C \beta_x \left(
  - K_1
  + K_2 (Dx - DDx)
  - \half K_3(Dx)^2
\right) \\
&\approx&
- \frac{1}{4 \pi} \left(
    - \sum_Q \beta_x K_1
    + \sum_S \beta_x K_2 (Dx - DDx)
    - \half \sum_O \beta_x K_3(Dx)^2
\right)
}\]
\[\myarray{
DDQ_y &=&
+ \frac{1}{4 \pi} \int_0^C \beta_y \left(
  - K_1
  + K_2 (Dx - DDx)
  - \half K_3(Dx)^2
\right) \\
&\approx&
+ \frac{1}{4 \pi} \left(
  - \sum_Q \beta_y K_1
  + \sum_S \beta_y K_2 (Dx - DDx)
  - \half \sum_O \beta_y K_3(Dx)^2
\right)
}\]

\[\myarray{
DDDQ_x &=&
- \frac{1}{4 \pi} \int_0^C \beta_x \left(
  + K_1
  - K_2 (Dx - DDx + DDDx)
  + K_3(\half(Dx)^2 - DxDDx)
  - \sixth K_3(Dx)^3
\right) \\
&\approx&
- \frac{1}{4 \pi} \left(
  + \sum_Q \beta_x K_1
  - \sum_S \beta_x K_2 (Dx - DDx + DDDx)
  + \sum_O \beta_x K_3(\half(Dx)^2 - DxDDx)
  - \sixth \sum_D \beta_x K_3(Dx)^3
\right)
}\]
\[\myarray{
DDDQ_y &=&
+ \frac{1}{4 \pi} \int_0^C \beta_y \left(
  + K_1
  - K_2 (Dx - DDx + DDDx)
  + K_3 (\half(Dx)^2 - DxDDx)
  - \sixth K_3(Dx)^3
\right) \\
&\approx&
+ \frac{1}{4 \pi} \left(
  + \sum_Q \beta_y K_1
  - \sum_S \beta_y K_2 (Dx - DDx + DDDx)
  + \sum_O \beta_y K_3 (\half(Dx)^2 - DxDDx)
  - \sixth \sum_D \beta_y K_3(Dx)^3
\right) \\
}\]

\section{Variation of Tunes with Energy}
\ttindex{HADTUN}
Find derivatives $\partial^2 Q / \partial\delta^2$ and
  $\partial^3 Q / \partial\delta^3$
***** section to be filled in *****

\section{Variation of Lattice Functions with Energy}
\ttindex{HADBET}
\ttindex{HADDSP}
Find derivatives $\partial D / \partial\delta$ and
  $\partial^2 D / \partial\delta^2$
Find derivatives $\partial\beta / \partial\delta$
***** section to be filled in *****

\section{Variation of Tunes with Amplitude}
\ttindex{HAATUN}
Find derivatives $\partial Q / \partial\varepsilon$
***** section to be filled in *****

\section{Resonance Effects}
\ttindex{HARESO}
\ttindex{HARSIG}
Compute resonance coefficients
Internal routine for {\tt HARESO}

\section{Fourth-Order Resonances}
\ttindex{HA4ANA}
\ttindex{HA4SUM}
Find fourth-order resonance coefficients
Internal routine for {\tt HA4ANA}

% ====================================================================

\begin{thebibliography}{99}

\bibitem{BAS80}
M.~Bassetti and G.~A.~Erskine.
{\it Closed expression for the electrical field of a two-dimensional
Gaussian charge}.
CERN-ISR-TH/80-06.

\bibitem{SLAC75}
Karl~L. Brown.
{\it A First-and Second-Order Matrix Theory for the Design
  of Beam Transport Systems and Charged Particle Spectrometers}.
SLAC 75, Revision 3, SLAC, 1972, and SLAC-PUB-3381, July 1984.

\bibitem{SLAC91}
K.~L.~Brown, D.~C.~Carey, Ch.~Iselin,and  F.~Rothacker,
{\it TRANSPORT --- A Computer Program for Designing Charged
  Particle Beam Transport Systems}.
CERN 73-16, revised as CERN 80-4, CERN, 1980.

\bibitem{CHA79}
A. Chao.
Evaluation of beam distribution parameters in an electron storage
ring.
{\it Journal of Applied Physics}, 50:595--598, 1979.
 
\bibitem{COU58}
E.~D. Courant and H.~S. Snyder.
{\it Theory of the alternating gradient synchrotron}.
Annals of Physics, 3:1--48, 1958.
 
\bibitem{DON82}
M.~Donald and D.~Schofield.
{\it A User's Guide to the HARMON Program}.
LEP Note 420, CERN, 1982.

\bibitem{DOU82}
D.~R.~Douglas,
{\it Lie Algebraic Methods for Particle Accelerator Theory}.
Doctoral thesis, University of Maryland, unpublished, 1982.
 
\bibitem{DRA81}
A.~Dragt,
{\it Lectures on Nonlinear Orbit Dynamics, 1981 Summer School on High
  Energy Particle Accelerators, Fermi National Accelerator Laboratory,
  July 1981}.
American Institute of Physics, 1982.

\bibitem{DRA82}
A.~Dragt,
{\it *****}

\bibitem{GRO90}
H.~Grote, F.~C.~Iselin,
{\it The MAD Program (Methodical Accelerator Design) Version 8.1,
User's Reference Manual},
CERN/SL/90-13 (AP).

\bibitem{HEA88}
L.~M.~Healy,
{\it Concatenation of Lie Algebraic Maps}.
CERN, LEP Note No. ???.

\bibitem{HEA86}
L.~M.~Healy,
{\it Lie Algebraic Methods for Treating Lattice Parameter Errors in
Particle Accelerators}.
Doctoral thesis, University of Maryland, unpublished, 1986.

\bibitem{JAE81}
J.~J\"ager and D.~M\"ohl,
{\it Comparison of Methods to Evaluate the Chromaticity in LEAR}.
CERN PS/DL/LEAR/Note 81-7.

\bibitem{ISE85}
F.~Ch.~Iselin,
{\it Lie Transformations and Transport Equations for Combined-Function
  Dipoles},
Particle Accelerators, 1985, {\bf 17}, 143-155.

\bibitem{MAI82}
H.~Mais and G.~Ripken,
{\it Theory of Coupled Synchro-Betatron Oscillations},
DESY internal Report, DESY M-82-05, 1982.
 
\bibitem{MIL88}
J. Milutinovic and S. Ruggiero.\hfil
{\it Comparison of Accelerator Codes for a RHIC Lattice}.
AD/AP/TN-9, BNL, 1988.

\bibitem{PEG81}
S.~Peggs,
{\it Some Aspects of Machine Physics in the Cornell Electron Storage
Ring},
Doctoral thesis, Cornell University, unpublished, 1981.

\bibitem{RIP70}
G.~Ripken,
{\it Untersuchungen zur Strahlf\"uhrung und Stabilit\"at der
Teilchenbewegung in Beschleunigern und Storage-Ringen unter strenger
Ber\"ucksichtigung einer Kopplung der Betatronschwingungen.},
DESY internal Report R1-70/4, 1970.

\bibitem{TEN71}
L.~C. Teng,
{\it Concerning n-Dimensional Coupled Motion}.
FN 229, FNAL, 1971.

\end{thebibliography}

% ====================================================================
\end{document}
\end
